<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-circle.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"msclock.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.21.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"github-dark"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"livere","storage":true,"lazyload":false,"nav":null,"activeClass":"livere"},"stickytabs":true,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/config.min.js"></script>

    <meta name="description" content="docker 安装 开发测试环境 1234567891011121314151617181920212223242526272829303132333435363738curl -fsSL https:&#x2F;&#x2F;get.docker.com | bash -s docker# 配置dockercat &gt;&#x2F;etc&#x2F;docker&#x2F;daemon.json&lt;&lt;EOF{  &quot;default-ru">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker 疑难问题">
<meta property="og:url" content="https://msclock.github.io/posts/7d9a968e/index.html">
<meta property="og:site_name" content="Live in the present">
<meta property="og:description" content="docker 安装 开发测试环境 1234567891011121314151617181920212223242526272829303132333435363738curl -fsSL https:&#x2F;&#x2F;get.docker.com | bash -s docker# 配置dockercat &gt;&#x2F;etc&#x2F;docker&#x2F;daemon.json&lt;&lt;EOF{  &quot;default-ru">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/oFw2cRPy1eKYEXt.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/s51tCy2ReQLqaif.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/DNOunbjFT91SIEA.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/uWRJryql2XSie1G.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/XzV5g3meuly1nBT.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/6SgjIkntAHVBdYi.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/PBw2jWYCgydkmUc.png">
<meta property="og:image" content="https://s2.loli.net/2022/09/12/VpwshZoGbNgAaCm.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20230410/103130689.png">
<meta property="article:published_time" content="2020-01-03T07:25:06.000Z">
<meta property="article:modified_time" content="2025-02-01T01:10:57.312Z">
<meta property="article:author" content="Msclock">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/09/12/oFw2cRPy1eKYEXt.png">


<link rel="canonical" href="https://msclock.github.io/posts/7d9a968e/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://msclock.github.io/posts/7d9a968e/","path":"posts/7d9a968e/","title":"Docker 疑难问题"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Docker 疑难问题 | Live in the present</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Live in the present</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Msclock's Notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">32</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">2</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">49</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker"><span class="nav-number">1.</span> <span class="nav-text">docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">1.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">更新</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dockerd"><span class="nav-number">1.2.</span> <span class="nav-text">dockerd</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cgroup-driver"><span class="nav-number">1.3.</span> <span class="nav-text">cgroup driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#command"><span class="nav-number">1.4.</span> <span class="nav-text">command</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-daemon-service"><span class="nav-number">1.4.1.</span> <span class="nav-text">docker daemon service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#volume"><span class="nav-number">1.4.2.</span> <span class="nav-text">volume</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-QA"><span class="nav-number">2.</span> <span class="nav-text">docker QA</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Got-permission-denied-while-trying-to-connect-to-the-Docker-daemon-socket-at-unix-var-run-docker-sock-Get-http-2Fvar-2Frun-2Fdocker-sock-v1-40-images-json-dial-unix-var-run-docker-sock-connect-permission-denied"><span class="nav-number">2.1.</span> <span class="nav-text">Got permission denied while trying to connect to the Docker daemon socket at unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker.sock: Get http:&#x2F;&#x2F;%2Fvar%2Frun%2Fdocker.sock&#x2F;v1.40&#x2F;images&#x2F;json: dial unix &#x2F;var&#x2F;run&#x2F;docker.sock: connect: permission denied</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-daemon-%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">docker daemon 配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-context"><span class="nav-number">4.</span> <span class="nav-text">docker context</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0-context"><span class="nav-number">4.1.</span> <span class="nav-text">添加 context</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.</span> <span class="nav-text">常用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reference"><span class="nav-number">4.3.</span> <span class="nav-text">reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-run-permission"><span class="nav-number">5.</span> <span class="nav-text">docker run permission</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%93cap-add"><span class="nav-number">5.1.</span> <span class="nav-text">–cap-add</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%93security-opt"><span class="nav-number">5.2.</span> <span class="nav-text">–security-opt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%93privileged"><span class="nav-number">5.3.</span> <span class="nav-text">–privileged</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E2%80%93gpus"><span class="nav-number">5.4.</span> <span class="nav-text">–gpus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#QA"><span class="nav-number">5.4.1.</span> <span class="nav-text">QA</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%89%A7%E8%A1%8C%E8%AE%BE%E7%BD%AE%E9%94%99%E8%AF%AF%E9%80%80%E5%87%BA"><span class="nav-number">5.5.</span> <span class="nav-text">容器中执行设置错误退出</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerignore"><span class="nav-number">6.</span> <span class="nav-text">dockerignore</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#reference-2"><span class="nav-number">6.1.</span> <span class="nav-text">reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerfile"><span class="nav-number">7.</span> <span class="nav-text">dockerfile</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RUN"><span class="nav-number">7.1.</span> <span class="nav-text">RUN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADD-COPY"><span class="nav-number">7.2.</span> <span class="nav-text">ADD &amp; COPY</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SHELL"><span class="nav-number">7.3.</span> <span class="nav-text">SHELL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerfile-%E4%BC%98%E5%8C%96"><span class="nav-number">8.</span> <span class="nav-text">dockerfile 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F"><span class="nav-number">8.1.</span> <span class="nav-text">选择基础镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E6%8C%87%E4%BB%A4%E9%A1%BA%E5%BA%8F"><span class="nav-number">8.2.</span> <span class="nav-text">优化指令顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%88%E5%B9%B6%E6%9E%84%E5%BB%BA%E6%8C%87%E4%BB%A4"><span class="nav-number">8.3.</span> <span class="nav-text">合并构建指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E7%90%86%E4%B8%AD%E9%97%B4%E7%BC%93%E5%AD%98"><span class="nav-number">8.4.</span> <span class="nav-text">清理中间缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E9%95%9C%E5%83%8F%E5%92%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E9%95%9C%E5%83%8F%E5%88%86%E7%A6%BB"><span class="nav-number">8.5.</span> <span class="nav-text">开发镜像和运行时镜像分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA"><span class="nav-number">8.6.</span> <span class="nav-text">多阶段构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-buildkit"><span class="nav-number">8.7.</span> <span class="nav-text">使用 buildkit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85"><span class="nav-number">8.8.</span> <span class="nav-text">二进制工具安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reference-3"><span class="nav-number">8.9.</span> <span class="nav-text">reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-inspect"><span class="nav-number">9.</span> <span class="nav-text">docker inspect</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#log"><span class="nav-number">9.1.</span> <span class="nav-text">log</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-port"><span class="nav-number">10.</span> <span class="nav-text">docker port</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#porting-%E6%98%A0%E5%B0%84"><span class="nav-number">10.1.</span> <span class="nav-text">porting 映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E4%BA%92%E8%81%94"><span class="nav-number">10.2.</span> <span class="nav-text">容器互联</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">10.3.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dumb-init"><span class="nav-number">11.</span> <span class="nav-text">dumb-init</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8-dumb-init"><span class="nav-number">11.1.</span> <span class="nav-text">为什么使用 dumb-init</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#install"><span class="nav-number">11.2.</span> <span class="nav-text">install</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83-2"><span class="nav-number">11.3.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-template"><span class="nav-number">12.</span> <span class="nav-text">docker template</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#python"><span class="nav-number">12.1.</span> <span class="nav-text">python</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E5%88%86%E5%B8%83"><span class="nav-number">12.1.1.</span> <span class="nav-text">版本分布</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%82%E8%80%83-3"><span class="nav-number">12.1.2.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql"><span class="nav-number">12.2.</span> <span class="nav-text">mysql</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-compose"><span class="nav-number">13.</span> <span class="nav-text">docker-compose</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GPU-support"><span class="nav-number">13.1.</span> <span class="nav-text">GPU support</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#healthcheck"><span class="nav-number">13.2.</span> <span class="nav-text">healthcheck</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#restart"><span class="nav-number">13.3.</span> <span class="nav-text">restart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#volume-2"><span class="nav-number">13.4.</span> <span class="nav-text">volume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config"><span class="nav-number">13.5.</span> <span class="nav-text">config</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-api"><span class="nav-number">14.</span> <span class="nav-text">docker api</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#python-client"><span class="nav-number">14.1.</span> <span class="nav-text">python client</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-swarm"><span class="nav-number">15.</span> <span class="nav-text">docker swarm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#swarm-%E7%AE%A1%E7%90%86"><span class="nav-number">15.1.</span> <span class="nav-text">swarm 管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8A%82%E7%82%B9%E7%AE%A1%E7%90%86"><span class="nav-number">15.2.</span> <span class="nav-text">节点管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86"><span class="nav-number">15.3.</span> <span class="nav-text">服务管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GPU"><span class="nav-number">15.4.</span> <span class="nav-text">GPU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-compose-2"><span class="nav-number">15.5.</span> <span class="nav-text">docker-compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UI"><span class="nav-number">15.6.</span> <span class="nav-text">UI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#swarmpit"><span class="nav-number">15.6.1.</span> <span class="nav-text">swarmpit</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#portainer"><span class="nav-number">15.6.2.</span> <span class="nav-text">portainer</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#swarm-mesh"><span class="nav-number">15.7.</span> <span class="nav-text">swarm mesh</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-proxy"><span class="nav-number">16.</span> <span class="nav-text">docker proxy</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Msclock"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Msclock</p>
  <div class="site-description" itemprop="description">That life is reality.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/msclock" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;msclock" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:msclock@qq.com" title="E-Mail → mailto:msclock@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/msclockg" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;msclockg" rel="noopener me" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://msclock.github.io/posts/7d9a968e/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Msclock">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Live in the present">
      <meta itemprop="description" content="That life is reality.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Docker 疑难问题 | Live in the present">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Docker 疑难问题
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-01-03 15:25:06" itemprop="dateCreated datePublished" datetime="2020-01-03T15:25:06+08:00">2020-01-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-01 09:10:57" itemprop="dateModified" datetime="2025-02-01T09:10:57+08:00">2025-02-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/develop/" itemprop="url" rel="index"><span itemprop="name">develop</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>21k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>19 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="docker">docker</h2>
<h3 id="安装">安装</h3>
<p>开发测试环境</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">curl -fsSL https://get.docker.com | bash -s docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置docker</span></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">{</span></span><br><span class="line"><span class="string">  "default-runtime": "nvidia",</span></span><br><span class="line"><span class="string">  "exec-opts": [</span></span><br><span class="line"><span class="string">    "native.cgroupdriver=systemd"</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  "runtimes": {</span></span><br><span class="line"><span class="string">    "nvidia": {</span></span><br><span class="line"><span class="string">      "args": [],</span></span><br><span class="line"><span class="string">      "path": "nvidia-container-runtime"</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">  },</span></span><br><span class="line"><span class="string">  "builder": {</span></span><br><span class="line"><span class="string">    "gc": {</span></span><br><span class="line"><span class="string">      "defaultKeepStorage": "20GB",</span></span><br><span class="line"><span class="string">      "enabled": true</span></span><br><span class="line"><span class="string">    }</span></span><br><span class="line"><span class="string">  },</span></span><br><span class="line"><span class="string">  "experimental": true,</span></span><br><span class="line"><span class="string">  "features": {</span></span><br><span class="line"><span class="string">    "buildkit": true</span></span><br><span class="line"><span class="string">  },</span></span><br><span class="line"><span class="string">  "insecure-registries": [</span></span><br><span class="line"><span class="string">    "harbor.baijiayun.com",</span></span><br><span class="line"><span class="string">    "docker.huaguisystems.com"</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  "registry-mirrors": [</span></span><br><span class="line"><span class="string">    "https://docker.mirrors.sjtug.sjtu.edu.cn",</span></span><br><span class="line"><span class="string">    "https://reg-mirror.qiniu.com"</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">}</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a></p>
</li>
</ul>
<h4 id="更新">更新</h4>
<p>查看系统版本，根据官方 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/">文档</a> 更新</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/os-release</span><br></pre></td></tr></tbody></table></figure>
<p>QA: <strong>Error response from daemon: Unknown runtime specified docker-runc</strong><br>
当从不兼容的版本升级 docker 并且升级后无法启动 docker 容器时会出现这种情况，执行一下<a target="_blank" rel="noopener" href="https://foxutech.com/how-to-upgrade-docker/#:~:text=Instructions%20to%20upgrade%20YUM-based%20systems.%20Add%20the%20Docker,other%20version%2C%20you%20can%20modify%20based%20on%20that.">命令</a>，然后重启 docker。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -rl <span class="string">'docker-runc'</span> /var/lib/docker/containers/ | xargs sed -i <span class="string">'s/docker-runc/runc/g'</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="dockerd">dockerd</h3>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep dockerd</span><br><span class="line">root        6515       1  1 15:28 ?        00:01:08 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br></pre></td></tr></tbody></table></figure>
<p><code>/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</code> 是 Docker daemon 的启动命令，其中：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>/usr/bin/dockerd 是 Docker daemon 的路径。</p>
</li>
<li class="lvl-2">
<p>-H fd:// 是 Docker daemon 的监听地址，fd:// 是一个特殊的 Unix socket，用于 systemd socket activation。</p>
</li>
<li class="lvl-2">
<p>–containerd=/run/containerd/containerd.sock 是指定 Docker daemon 使用的 containerd 的 socket 文件路径。</p>
</li>
</ul>
<p>Docker daemon 使用 containerd 作为其默认的容器运行时，主要是因为 containerd 是一个轻量级的、高性能的开源容器运行时，它可以管理完整的容器生命周期，包括镜像管理、容器执行、任务管理、网络管理等。</p>
<p>除了 containerd，Docker 还支持其他的容器运行时，例如 runc、gVisor、Kata Containers 等。可以通过修改 Docker daemon 的配置文件来更改默认的容器运行时。</p>
<h3 id="cgroup-driver">cgroup driver</h3>
<p>Docker 的 cgroup driver 主要有两种类型：systemd 和 cgroupfs。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>systemd: 当 Docker 使用 systemd 作为其 cgroup driver 时，它将会使用 systemd 来创建和管理 cgroup。这意味着 Docker 将会与系统的其他部分（也使用 systemd 的部分）共享同一套 cgroup，从而实现更好的资源管理。</p>
</li>
<li class="lvl-2">
<p>cgroupfs: 当 Docker 使用 cgroupfs 作为其 cgroup driver 时，它将会直接与 cgroup 文件系统交互来创建和管理 cgroup。这意味着 Docker 将会有自己独立的一套 cgroup，与系统的其他部分（使用 systemd 的部分）分开。</p>
</li>
</ul>
<p>总的来说，systemd 和 cgroupfs 的主要区别在于它们与系统的其他部分的交互方式不同。systemd 更倾向于与系统的其他部分共享资源，而 cgroupfs 则更倾向于独立管理资源。</p>
<p>要将 Docker 的 cgroup driver 从 cgroupfs 迁移到 systemd，需要在 Docker 的配置文件中进行更改。以下是步骤：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>打开 Docker 的配置文件，通常位于 /etc/docker/daemon.json。如果文件不存在，需要创建它。</p>
</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/docker/daemon.json</span><br></pre></td></tr></tbody></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>在配置文件中添加或修改 "exec-opts"，将其设置为 "native.cgroupdriver=systemd"。</p>
</li>
</ul>
<figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">  <span class="attr">"exec-opts"</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">"native.cgroupdriver=systemd"</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>保存并关闭文件，然后重启 Docker 服务。</p>
</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart docker</span><br></pre></td></tr></tbody></table></figure>
<p>迁移到 systemd 的好处主要有：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>更好的资源管理：systemd 可以与系统的其他部分共享 cgroup，从而实现更好的资源管理。</p>
</li>
<li class="lvl-2">
<p>更好的兼容性：一些 Kubernetes 工具（如 kubeadm）要求 Docker 使用 systemd 作为其 cgroup driver，以确保与 Kubernetes 的兼容性。</p>
</li>
<li class="lvl-2">
<p>更好的稳定性：systemd 作为 cgroup driver 的稳定性通常比 cgroupfs 更好。</p>
</li>
</ul>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/633832183">https://zhuanlan.zhihu.com/p/633832183</a></p>
</li>
</ul>
<h3 id="command">command</h3>
<h4 id="docker-daemon-service">docker daemon service</h4>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service docker start/stop/restart/status</span><br><span class="line">systemctl start/stop/restart docker</span><br></pre></td></tr></tbody></table></figure>
<h4 id="volume">volume</h4>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 清除匿名不再引用的 volume</span></span><br><span class="line">docker volume prune</span><br><span class="line"><span class="comment"># 清除所有不再引用的 volume</span></span><br><span class="line">docker volume <span class="built_in">ls</span> -f dangling=<span class="literal">true</span> | awk <span class="string">'{print $2}'</span> | xargs docker volume <span class="built_in">rm</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="docker-QA">docker QA</h2>
<p>以下为 Docker 中各种疑难问题及解答</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/136264.htm">CMD 和 ENTRYPOINT 命令</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/124687.htm">在 Docker 容器中捕获信号</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.jb51.net/article/136264.htm">如何忽略 ENTRYPOINT 指令</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/43a2bb9b.html">docker 常见文件汇总</a></p>
</li>
</ul>
<h3 id="Got-permission-denied-while-trying-to-connect-to-the-Docker-daemon-socket-at-unix-var-run-docker-sock-Get-http-2Fvar-2Frun-2Fdocker-sock-v1-40-images-json-dial-unix-var-run-docker-sock-connect-permission-denied">Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.40/images/json: dial unix /var/run/docker.sock: connect: permission denied</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://linuxhandbook.com/docker-permission-denied/">https://linuxhandbook.com/docker-permission-denied/</a></p>
</li>
</ul>
<h2 id="docker-daemon-配置">docker daemon 配置</h2>
<p>docker 运行配置主要通过文件 daemon.json 配置。所在路径在 <code>/etc/docker/daemon.json</code>。</p>
<figure class="highlight jsonc"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">{</span></span><br><span class="line">    <span class="comment">// 配置docker运行数据储存路径</span></span><br><span class="line">    <span class="attr">"data-root"</span><span class="punctuation">:</span> <span class="string">"/home/docker"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 配置docker仓库源</span></span><br><span class="line">    <span class="attr">"insecure-registries"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="comment">// 私有源</span></span><br><span class="line">      <span class="string">"harbor.xxx.com"</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// 公开源</span></span><br><span class="line">    <span class="attr">"registry-mirrors"</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">"https://docker.mirrors.sjtug.sjtu.edu.cn"</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">}</span></span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/">Docker 官方文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.simapple.com/docker-chinese-manual">Docker 中文文档</a></p>
</li>
</ul>
<h2 id="docker-context">docker context</h2>
<p>docker context 用于本地方便地访问远程主机的 docker 服务。在不需要手动通过 ssh 连接远程服务器时比较有帮助。</p>
<h3 id="添加-context">添加 context</h3>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker context create &lt;context-name&gt; --docker <span class="string">"host=ssh://format"</span></span><br></pre></td></tr></tbody></table></figure>
<p>这里 <strong>format</strong> 可使用一下格式:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>username@host-ip[:port]</p>
</li>
<li class="lvl-2">
<p>name，指在～/.ssh/config 中提供的 ssh 连接配置名称。</p>
</li>
</ul>
<p>示例:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> ~/.ssh/config</span><br><span class="line">Host my-remote-docker-machine</span><br><span class="line">  Hostname host</span><br><span class="line">  User username</span><br><span class="line">  Port 12345</span><br><span class="line"></span><br><span class="line">$ docker context create my-remote-docker-machine --docker <span class="string">"host=ssh://my-remote-docker-machine"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="常用命令">常用命令</h3>
<p>下面列出了常用的 docker context 命令和示例。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker --context my-remote-docker-machine images -q</span><br><span class="line">65dadc9c7fe7</span><br><span class="line">f814fce55133</span><br><span class="line">7a9b6da4328e</span><br><span class="line">33655f17f093</span><br><span class="line">d120da10b040</span><br><span class="line">6d6859d1a42a</span><br><span class="line">c19ae228f069</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker context use my-remote-docker-machine</span><br><span class="line">my-remote-docker-machine</span><br><span class="line">Current context is now <span class="string">"my-remote-docker-machine"</span></span><br><span class="line">$ docker context <span class="built_in">ls</span></span><br><span class="line">NAME                         DESCRIPTION                               DOCKER ENDPOINT               KUBERNETES ENDPOINT   ORCHESTRATOR</span><br><span class="line">default                      Current DOCKER_HOST based configuration   unix:///var/run/docker.sock                         swarm</span><br><span class="line">my-remote-docker-machine *                                             ssh://username@host</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker context use default <span class="comment"># back to default</span></span><br><span class="line">$ docker context <span class="built_in">rm</span> my-remote-docker-machine</span><br><span class="line">my-remote-docker-machine</span><br></pre></td></tr></tbody></table></figure>
<p>使用 docker 上下文可能有助于避免手动将 SSH 连接到远程服务器。但是，当涉及到在本地使用远程 docker 构建映像时，需要考虑将上载 / 下载多少 docker 上下文。</p>
<h3 id="reference">reference</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://clavinjune.dev/en/blogs/working-with-remote-docker-using-docker-context/">https://clavinjune.dev/en/blogs/working-with-remote-docker-using-docker-context/</a></p>
</li>
</ul>
<h2 id="docker-run-permission">docker run permission</h2>
<h3 id="–cap-add">–cap-add</h3>
<p>通常用于开发用的镜像需要设置 cli 参数给予相应的容器权限。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>–cap-add=NET_RAW: 允许容器进程使用原始套接字，直接访问网络层，一般进行网络嗅探等网络底层操作的容器进程需要。</p>
</li>
<li class="lvl-2">
<p>–cap-add=SYS_PTRACE: 允许容器进程使用 ptrace 系统调用。 ptrace 允许一个进程监视和控制另一个进程的执行，包括读取和修改其内存和寄存器状态。这个选项通常用于需要进行调试或其他进程控制操作的容器。</p>
</li>
<li class="lvl-2">
<p>–cap-add=NET_ADMIN: 允许容器进程使用网络管理功能。该选项需要对网络进行配置或管理的容器，例如配置网络接口、设置路由或进行网络诊断等操作。</p>
</li>
</ul>
<h3 id="–security-opt">–security-opt</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>–security-opt seccomp=unconfined: 允许设置容器的 seccomp 配置。seccomp 是一种 Linux 内核安全模块，它可以限制进程可以执行的系统调用。该选项禁用 seccomp 配置，从而允许容器进程执行所有系统调用，通常用于需要执行一些不受限制的系统调用的容器，但是这也会降低容器的安全性。</p>
</li>
</ul>
<h3 id="–privileged">–privileged</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>它允许容器进程拥有主机上的所有特权。这个选项通常用于需要访问主机上的特权设备或执行一些需要特权的操作的容器。使用这个选项会增加容器的安全风险，因为容器进程可以访问主机</p>
</li>
</ul>
<h3 id="–gpus">–gpus</h3>
<p>允许访问主机 gpu 资源</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>[num]: gpu 数量</p>
</li>
<li class="lvl-2">
<p>all: 所有 gpu</p>
</li>
</ul>
<blockquote>
<p>[!TIP]<br>
如果需要支持 Nvidia Cuda，则需要额外安装支持的 <a target="_blank" rel="noopener" href="https://github.com/NVIDIA/nvidia-docker">Docker Runtime</a></p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt update &amp;&amp; apt install -y nvidia-docker2 \</span><br><span class="line">&amp;&amp; nvidia-ctk runtime configure</span><br></pre></td></tr></tbody></table></figure>
</blockquote>
<p>验证 gpu 是否可用</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://catalog.ngc.nvidia.com/orgs/nvidia/teams/k8s/containers/cuda-sample</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --gpus=all nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="QA">QA</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>failed to create task for container: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error running hook #0: error running hook: exit status 1, stdout: , stderr: nvidia-container-cli: requirement error: unsatisfied condition: cuda&gt;=11.7: unknown.</p>
</li>
</ul>
<p>镜像版本要求 cuda 需要大于 11.7:</p>
<ol>
<li class="lvl-3">
<p>升级驱动满足镜像要求</p>
</li>
<li class="lvl-3">
<p>采用符合要求的镜像</p>
</li>
</ol>
<h3 id="容器中执行设置错误退出">容器中执行设置错误退出</h3>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set -e 配置遇到错误即退出,并设置退出错误码255</span></span><br><span class="line">docker run --<span class="built_in">rm</span> \</span><br><span class="line">    --volume <span class="string">"<span class="variable">$PWD</span>"</span>:/src \</span><br><span class="line">        -w /src \</span><br><span class="line">        python:3.8-bullseye \</span><br><span class="line">        bash -c <span class="string">"set -e &amp;&amp; \</span></span><br><span class="line"><span class="string">            pip config set global.index-url "</span>https://pypi.tuna.tsinghua.edu.cn/simple/<span class="string">" &amp;&amp; \</span></span><br><span class="line"><span class="string">            pip config set global.trusted-host "</span>pypi.tuna.tsinghua.edu.cn<span class="string">" &amp;&amp; \</span></span><br><span class="line"><span class="string">            pip install mlflow==2.4.2 || \</span></span><br><span class="line"><span class="string">            exit 255"</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="dockerignore">dockerignore</h2>
<p>.dockerignore 主要用于在 docker 构建镜像时忽略不需要打包进去的过滤方式，类似于 .gitignore 文件。该文件位于构建上下文的根目录。</p>
<p>匹配规则如下:</p>
<table>
<thead>
<tr>
<th>pattern</th>
<th style="text-align:left">description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>/temp</em></td>
<td style="text-align:left"> 匹配根路径下一级目录下所有以 temp 开头的文件或目录</td>
</tr>
<tr>
<td><em> /</em>/temp*</td>
<td style="text-align:left"> 匹配根路径下两级目录下所有以 temp 开头的文件或目录</td>
</tr>
<tr>
<td> temp?</td>
<td style="text-align:left"> 匹配根路径下以 temp 开头，任意一个字符结尾的文件或目录</td>
</tr>
<tr>
<td> **/*.go</td>
<td style="text-align:left"> 匹配所有路径下以 .go 结尾的文件或目录，即递归搜索所有路径</td>
</tr>
<tr>
<td> *.md<br>!<a target="_blank" rel="noopener" href="http://README.md">README.md</a></td>
<td style="text-align:left"> 匹配根路径下所有以 .md 结尾的文件或目录，但 <a target="_blank" rel="noopener" href="http://README.md">README.md</a> 除外</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!CAUTION]<br>
如果存在冲突的行或重叠包含关系，那么以后面的匹配规则为准。</p>
</blockquote>
<h3 id="reference-2">reference</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qianghaohao/article/details/87902806">https://blog.csdn.net/qianghaohao/article/details/87902806</a></p>
</li>
</ul>
<h2 id="dockerfile">dockerfile</h2>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/oFw2cRPy1eKYEXt.png" alt="容器优化的思路和方法."></p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p>
</li>
</ul>
<h3 id="RUN">RUN</h3>
<p>使用 EOF 避免使用冗余的换行符运行，dockerfile:1.4 声明版本，或者直接指定版本 1</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># syntax=docker/dockerfile:1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> &lt;&lt;-<span class="string">EOF</span></span></span><br><span class="line">    set -o errexit -o nounset -o pipefail</span><br><span class="line">    cd clash-dashboard</span><br><span class="line">    npm config set registry https://registry.npmmirror.com</span><br><span class="line">    npm i -g pnpm</span><br><span class="line">    pnpm install</span><br><span class="line">    npm <span class="keyword">run</span><span class="language-bash"><span class="string"> build</span></span></span><br><span class="line">EOF</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#here-documents">https://docs.docker.com/engine/reference/builder/#here-documents</a></p>
</li>
</ul>
<h3 id="ADD-COPY">ADD &amp; COPY</h3>
<blockquote>
<p>在编写 Dockerfile 时经常需要拷贝文件或文件夹的操作，这时就需要用到 ADD 和 COPY 指令。</p>
</blockquote>
<ul class="lvl-0">
<li class="lvl-2">
<p>拷贝单个文件到指定目录</p>
</li>
</ul>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拷贝当前目录下的test.jar到/usr/bin目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./test.jar /usr/bin/</span></span><br></pre></td></tr></tbody></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>拷贝特定的多个文件到指定目录</p>
</li>
</ul>
<p>ADD 指令支持通配符，常用的示例如下：</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拷贝当前目录下的bin文件夹的所有sh文件到/usr/bin目录下</span></span><br><span class="line"><span class="comment">#拷贝当前目录下的bin文件夹的所有sh文件到/usr/bin目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./bin/*.sh /usr/bin/</span></span><br><span class="line"><span class="comment">#拷贝当前目录下的bin文件夹的所有带后缀的文件到/usr/bin目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./bin/*.* /usr/bin/</span></span><br><span class="line"><span class="comment">#拷贝当前目录下的bin文件夹的所有不带后缀的文件到/usr/bin目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./bin/* /usr/bin/</span></span><br><span class="line"><span class="comment">#拷贝当前目录下的bin文件夹的所有文件到/usr/bin目录下（/usr/bin目录原有的文件会保留）</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./bin/ /usr/bin/</span></span><br></pre></td></tr></tbody></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>拷贝文件夹到指定的目录</p>
</li>
</ul>
<p>ADD 宿主机文件夹的全路径 docker 容器下的文件夹路径 + 新文件夹名</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拷贝当前目录下的config文件夹到/usr/bin目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> ./config /usr/bin/config</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="SHELL">SHELL</h3>
<p>用于覆盖默认的 Shell</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># syntax=docker/dockerfile:1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> docker:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> &lt;&lt;-<span class="string">EOF</span></span></span><br><span class="line">    set -x</span><br><span class="line">    apk update &amp;&amp; apk <span class="keyword">add</span><span class="language-bash"><span class="string"> --no-cache bash npm nodejs git</span></span></span><br><span class="line">    npm install -g @devcontainers/cli</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># Override default shell as bash</span></span><br><span class="line"><span class="keyword">SHELL</span><span class="language-bash"><span class="string"> ["/bin/bash", "-c"]</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/builder/#shell">https://docs.docker.com/engine/reference/builder/#shell</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/42216046/18916219">https://stackoverflow.com/a/42216046/18916219</a></p>
</li>
</ul>
<h2 id="dockerfile-优化">dockerfile 优化</h2>
<h3 id="选择基础镜像">选择基础镜像</h3>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/s51tCy2ReQLqaif.png" alt="选择官方镜像."></p>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/DNOunbjFT91SIEA.png" alt="使用具体的镜像 tag."></p>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/uWRJryql2XSie1G.png" alt="使用最小基础镜像."></p>
<h3 id="优化指令顺序">优化指令顺序</h3>
<p>把 WORKDIR/ENV 等命令放在前面，COPY/ADD 等命令放在后面 [^2]。</p>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/XzV5g3meuly1nBT.png" alt="优化 WORKDIR/ENV 和 COPY/ADD 顺序."></p>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/6SgjIkntAHVBdYi.png" alt="使用更具体的 COPY 路径."></p>
<h3 id="合并构建指令">合并构建指令</h3>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/PBw2jWYCgydkmUc.png" alt="合并多个 RUN 指令，减少层数."></p>
<h3 id="清理中间缓存">清理中间缓存</h3>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://s2.loli.net/2022/09/12/VpwshZoGbNgAaCm.png" alt="清理系统包信息缓存."></p>
<p>用户数据缓存:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>~/.cache 等用户缓存。</p>
</li>
<li class="lvl-2">
<p>安装包临时缓存。</p>
</li>
</ul>
<h3 id="开发镜像和运行时镜像分离">开发镜像和运行时镜像分离</h3>
<p>runtime 镜像仅包含基本运行环境，开发镜像包含所有的开发依赖。开发镜像尽可能以 runtime 镜像为基础构建。</p>
<h3 id="多阶段构建">多阶段构建</h3>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20230410/103130689.png" alt="多阶段构建"></p>
<h3 id="使用-buildkit">使用 buildkit</h3>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建多平台镜像</span></span><br><span class="line">$ docker buildx build --platform \</span><br><span class="line">    linux/arm,linux/arm64,linux/amd64 \</span><br><span class="line">    -t &lt;group&gt;/hello . --push</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像信息</span></span><br><span class="line">$ docker buildx imagetools inspect &lt;group&gt;/hello</span><br></pre></td></tr></tbody></table></figure>
<p>使用构建缓存 <a target="_blank" rel="noopener" href="https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/reference.md">RUN --mount</a></p>
<blockquote>
<p>[!CAUTION]<br>
buildkit 会使用 docker 构建缓存，也就是 Build Cache，需要定期清理。</p>
<p>查看缓存：docker system df</p>
<p>清理方式：echo yes | docker builder prune -a</p>
</blockquote>
<h3 id="二进制工具安装">二进制工具安装</h3>
<p>从现有镜像中安装二进制文件</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.17</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> GOLANG_LINT_VERSION=V1.<span class="number">43.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> GOV PATH=/usr/local/bin/govc</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=vmware/govc:v0.27.2 /govc /usr/local/bin</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=dtzar/helm-kubectl:3.8.0 /usr/local/bin /usr/local/bin</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=koalaman/shellcheck:stable /bin/shellcheck /usr/local/bin/shellcheck</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> -from=docker: 20.10.12-dind-rootless /usr/local/bin/docker /usr/local/bin/docker</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=hashicorp/packer:1.8 /bin/packer /usr/local/bin</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=quay.io/argoproj/argocli:v3.2.6 /bin/argo /usr/local/bin</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="reference-3">reference</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/36c7bd6f.html">dockerfile 优化参考</a></p>
</li>
</ul>
<h2 id="docker-inspect">docker inspect</h2>
<p>docker inspect 输出可以通过 <code>--format</code>, 使用 <code>{{.}}</code> 检索某个字段结果</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出原始数据, 这里`.`表示所有结果</span></span><br><span class="line">docker inspect --format <span class="string">'{{.}}'</span> &lt;container name&gt;</span><br><span class="line"><span class="comment"># 以json输出,并检索字段 LogPath</span></span><br><span class="line">docker inspect --format <span class="string">'{{json .LogPath}}'</span> &lt;container name&gt; | jq</span><br><span class="line"><span class="comment"># 以表格输出</span></span><br><span class="line">docker inspect --format <span class="string">'table {{.ID}}\t{{.Name}}\t{{.Node}}\t{{.CurrentState}}'</span> &lt;container name&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="log">log</h3>
<p>Docker 默认将日志存储到一个日志文件中。要检查日志文件路径，请运行命令</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker inspect --format=<span class="string">'{{.LogPath}}'</span> containername</span><br><span class="line"></span><br><span class="line">/var/lib/docker/containers/f844a7b45ca5a9589ffaa1a5bd8dea0f4e79f0e2ff639c1d010d96afb4b53334/f844a7b45ca5a9589ffaa1a5bd8dea0f4e79f0e2ff639c1d010d96afb4b53334-json.log</span><br></pre></td></tr></tbody></table></figure>
<p>要查看实时日志，可以在以下命令中运行</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f `docker inspect --format=<span class="string">'{{.LogPath}}'</span> containername`</span><br></pre></td></tr></tbody></table></figure>
<p>注意：</p>
<p><code>/var/lib/docker/containers/f844a7b45ca5a9589ffaa1a5bd8dea0f4e79f0e2ff639c1d010d96afb4b53334/f844a7b45ca5a9589ffaa1a5bd8dea0f4e79f0e2ff639c1d010d96afb4b53334-json.log</code> 仅当 docker 生成日志（如果没有日志）时，才会创建此日志文件，否则该文件将不存在。如果我们运行命令 <code>docker logs containername</code>，它类似于某个时候，但什么也不返回。在这种情况下，该文件将不可用。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>重定向</p>
</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f &lt;yourContainer&gt; &amp;&gt; your.log &amp;</span><br></pre></td></tr></tbody></table></figure>
<p>说明：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>-f（即–follow）：写入所有现有日志，并继续（跟随）记录接下来出现的所有内容。</p>
</li>
<li class="lvl-2">
<p>&amp;&gt; 重定向标准输出和标准错误。</p>
</li>
<li class="lvl-2">
<p>可能想在后台运行该方法，因此 &amp;。</p>
</li>
<li class="lvl-2">
<p>可以通过以下方式将输出和 stderr 分开：（&gt; output.log 2&gt; error.log 而不是使用 &amp;&gt;）。</p>
</li>
</ul>
<h2 id="docker-port">docker port</h2>
<h3 id="porting-映射">porting 映射</h3>
<p>默认情况下，宿主机是无法访问容器内部网络的，但是可以使用端口映射来解决这个问题。主要通过 docker run 跟 -P（大写） 或 -p（小写）参数来实现。docker run -P 会把容器中监听的端口随机绑定到宿主机的可用端口上：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -p &lt;format&gt; image</span><br><span class="line"><span class="comment"># 默认是 tcp 协议，如果是 udp 协议，则可以显示指定</span></span><br><span class="line">docker run -d -p 127.0.0.1:8080:80/udp nginx:latest</span><br><span class="line"><span class="comment"># 查看容器 port 映射情况</span></span><br><span class="line">docker port container_ID <span class="comment">#容器ID</span></span><br><span class="line"><span class="comment">#将nginx的80端口映射到宿主机的800端口上</span></span><br><span class="line">docker run -d --name ng -it -p 800:80 nginx</span><br><span class="line"><span class="comment"># docker port ng</span></span><br><span class="line">80/tcp -&gt; 0.0.0.0:800</span><br></pre></td></tr></tbody></table></figure>
<p><code>&lt;format&gt;</code> 指定格式如下</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ip:hostport:containerport #指定 ip、指定宿主机 port、指定容器 port</p>
</li>
<li class="lvl-2">
<p>ip::containerport #指定 ip、未指定宿主机 port（随机）、指定容器 port</p>
</li>
<li class="lvl-2">
<p>hostport:containerport #未指定 ip、指定宿主机 port、指定容器 port</p>
</li>
</ul>
<h3 id="容器互联">容器互联</h3>
<p>容器互联通过 --link 配置链接实现单独隔离容器的互联。</p>
<p>以下以 nginx + php-fpm 示例：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里分别有一个 php-fpm 和 nginx 镜像。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1、先启动php-fpm 容器， 并使用 --name 参数指定容器名</span></span><br><span class="line">[root@localhost ~] docker run -d --name php-fpm php:5.6.32-fpm</span><br><span class="line">3e4b04174da9a91f77d9560113d3021f90a9638165968ccff44fede6c7961871</span><br><span class="line"><span class="comment"># 每一个运行中的Docker容器都有一块虚拟网卡和一个内网ip，可以进到上面的容器来查看：</span></span><br><span class="line"><span class="comment"># 先安装ifconfig命令，然后使用ifconfig查看ip地址信息</span></span><br><span class="line">[root@localhost ~] docker <span class="built_in">exec</span> -it php-fpm /bin/bash</span><br><span class="line">root@3e4b04174da9:/var/www/html# apt-get update</span><br><span class="line">root@3e4b04174da9:/var/www/html# apt-get install net-tools</span><br><span class="line">root@3e4b04174da9:/var/www/html# ifconfig</span><br><span class="line"><span class="comment"># 可以看到php-fpm容器有一块 eth0 网卡， 其ip地址为 172.17.0.54，还可以查看hosts信息</span></span><br><span class="line">root@3e4b04174da9:/var/www/html# <span class="built_in">cat</span> /etc/hosts</span><br><span class="line"><span class="comment"># 容器ID解析到了该容器局域网IP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、再启动nginx容器，同样指定一个名字，并使用 --link 连接到之前的php-fpm容器。</span></span><br><span class="line">[root@localhost ~] docker run -d -p 8080:80 --name nginx --<span class="built_in">link</span> php-fpm nginx:latest</span><br><span class="line">03fe0d3fbd43b5db157992703f70dd6eff4555c4e49c3620e7a212c81824778f</span><br><span class="line"><span class="comment"># 此时 nginx 容器就连接到 php-fpm 容器上了，可以进入nginx容器查看相关环境变量和hosts信息</span></span><br><span class="line">[root@localhost ~] docker <span class="built_in">exec</span> -it nginx /bin/bash</span><br><span class="line">root@03fe0d3fbd43:/ <span class="built_in">env</span></span><br><span class="line"><span class="comment"># 能够看到 nginx 容器中有很多 PHP_FPM 相关的环境变量，而hosts中除了有本身容器ID与自身IP地址的解析关系外，</span></span><br><span class="line"><span class="comment"># 还包含了php-fpm 容器的解析，我们可以使用 ping 或 telnet 命令查看两个容器之间的网络是否畅通。</span></span><br><span class="line"><span class="comment"># 先安装 ping 和 telnet ：</span></span><br><span class="line">root@03fe0d3fbd43:/ apt-get install iputils-ping</span><br><span class="line">root@03fe0d3fbd43:/ apt-get install telnet</span><br><span class="line">root@03fe0d3fbd43:/ ping php-fpm</span><br><span class="line"><span class="comment"># 看到连接了容器之后可以直接用容器名来访问,非常方便</span></span><br><span class="line"><span class="comment"># 现在我们可以配置 nginx 的 fastcgi， 转发php请求到 php-fpm 容器</span></span><br><span class="line"><span class="comment"># 先安装VI：</span></span><br><span class="line">root@03fe0d3fbd43:/ apt-get install vim-tiny</span><br><span class="line"><span class="comment"># 然后修改 /etc/nginx/conf.d/default.nginx</span></span><br><span class="line"><span class="comment"># 记得修改好后 reload 一下nginx</span></span><br><span class="line">root@03fe0d3fbd43:/ /etc/init.d/nginx reload</span><br><span class="line"><span class="comment"># 在php-fpm容器的 /php 目录下创建一个 test.php，并添加相应的权限</span></span><br><span class="line">[root@localhost ~] docker <span class="built_in">exec</span> -it php-fpm /bin/bash</span><br><span class="line">root@0805ea04f2c8:/var/www/html# <span class="built_in">mkdir</span> /php</span><br><span class="line">root@0805ea04f2c8:/var/www/html# <span class="built_in">echo</span> <span class="string">'&lt;?php echo time() . "\n";'</span> &gt; /php/test.php</span><br><span class="line">root@0805ea04f2c8:/var/www/html# <span class="built_in">chmod</span> 777 /php/test.php</span><br><span class="line"><span class="comment"># 然后在宿主机下访问该php文件：</span></span><br><span class="line">[root@localhost ~] curl <span class="string">'127.0.0.1:8080/test.php'</span></span><br><span class="line">1509695115</span><br><span class="line">[root@localhost ~] curl <span class="string">'127.0.0.1:8080/test.php'</span></span><br><span class="line">1509695138</span><br></pre></td></tr></tbody></table></figure>
<h3 id="参考">参考</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.h5w3.com/tag/Docker">https://www.h5w3.com/tag/Docker</a></p>
</li>
</ul>
<h2 id="dumb-init">dumb-init</h2>
<p>这里介绍了一种容器初始化系统 <a target="_blank" rel="noopener" href="https://github.com/Yelp/dumb-init"><code>dumb-init</code></a>。</p>
<p>主要关注于解决两个问题。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>作为 <code>PID</code> 为 1 容器进程的信号处理。</p>
</li>
<li class="lvl-2">
<p>孤儿僵尸进程回收。</p>
</li>
</ul>
<span id="more"></span>
<h3 id="为什么使用-dumb-init">为什么使用 dumb-init</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhongbeida_xue/article/details/107489863">参考博客 1</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/MrVolleyball/p/10177568.html">参考博客 2</a></p>
</li>
</ul>
<p>使用时需注意<a target="_blank" rel="noopener" href="https://github.com/Yelp/dumb-init#usage">参考</a></p>
<h3 id="install">install</h3>
<p>通过系统命令安装。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum/apt/apk install -y dumb-init</span><br></pre></td></tr></tbody></table></figure>
<p>通过 pip 安装管理器。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install dumb-init</span><br></pre></td></tr></tbody></table></figure>
<p>通过 github 安装</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RUN wget -O /usr/local/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v1.2.5/dumb-init_1.2.5_x86_64</span><br><span class="line">RUN <span class="built_in">chmod</span> +x /usr/local/bin/dumb-init</span><br></pre></td></tr></tbody></table></figure>
<h3 id="参考-2">参考</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/Yelp/dumb-init">dumb-init</a></p>
</li>
</ul>
<h2 id="docker-template">docker template</h2>
<p>本文主要搜集了标准的 docker 镜像的标准模板。</p>
<!-- more -->
<h3 id="python">python</h3>
<p><a target="_blank" rel="noopener" href="https://github.com/docker-library/python">python 官方标准模板</a> 包括 python3 的基础镜像。</p>
<h4 id="版本分布">版本分布</h4>
<p>版本分布 bullseye/buster/alpine：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>slim 最小安装，不包含 gdb 调试脚本加载。</p>
</li>
<li class="lvl-2">
<p>非 slim，<a target="_blank" rel="noopener" href="https://github.com/docker-library/python/pull/701">包含 gdb 调试脚本</a>（建议使用）。</p>
</li>
<li class="lvl-2">
<p>alpine 非 glibc 的最小镜像模板。</p>
</li>
</ul>
<h4 id="参考-3">参考</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://devguide.python.org/advanced-tools/gdb/index.html">python 开发手册支持 gdb</a></p>
</li>
</ul>
<h3 id="mysql">mysql</h3>
<p>这里简单介绍 docker 启动配置 mysql 服务方式。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014576291/article/details/105890286">安装 8.0.20</a></p>
</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装时映射到容器中的3306即可</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">docker run \</span><br><span class="line">  -p 3365:3306 \</span><br><span class="line">  --name mysql5.7.21 \</span><br><span class="line">  --privileged=<span class="literal">true</span> \</span><br><span class="line">  <span class="comment"># no #不重启(不带restart参数时，默认不重启)</span></span><br><span class="line">  <span class="comment"># on-failure  #退出状态非0时重启</span></span><br><span class="line">  <span class="comment"># always  #始终重启</span></span><br><span class="line">  --restart=always \ <span class="comment">#在宿主机重启后或者Docker服务重启后自动启动容器，</span></span><br><span class="line">  -v /opt/mysql5.7.21/mysql:/etc/mysql \</span><br><span class="line">  -v /opt/mysql5.7.21/logs:/logs \</span><br><span class="line">  -v /opt/mysql5.7.21/data:/var/lib/mysql \</span><br><span class="line">  -v /etc/localtime:/etc/localtime \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=123456 \</span><br><span class="line">  -d mysql:5.7.21 \</span><br><span class="line">  --character-set-server=utf8mb4 \</span><br><span class="line">  --collation-server=utf8mb4_general_ci   <span class="comment">#设置编码为utf8mb4</span></span><br></pre></td></tr></tbody></table></figure>
<!-- more -->
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42088970/article/details/87929517">安装 5.7.21</a></p>
</li>
</ul>
<h2 id="docker-compose">docker-compose</h2>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/compose/">docker-compose</a> 是一个多容器编排工具，常用于开发配置.</p>
<h3 id="GPU-support">GPU support</h3>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/compose/gpu-support/">docker-compose gpu support</a>.</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">test:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">              <span class="attr">count:</span> <span class="string">all</span></span><br><span class="line">              <span class="attr">capabilities:</span> [<span class="string">gpu</span>]</span><br></pre></td></tr></tbody></table></figure>
<h3 id="healthcheck">healthcheck</h3>
<p>CMD 和 CMD-SHELL 是 Docker Compose 文件中用于定义容器健康检查的两种不同的命令类型。</p>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3.8"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">minio:</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">"CMD"</span>, <span class="string">"curl"</span>, <span class="string">"-f"</span>, <span class="string">"http://minio:9000/minio/health/live"</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tritonserver:</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="attr">minio:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_healthy</span></span><br><span class="line">      <span class="attr">create_models_buckets:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">service_completed_successfully</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">"CMD-SHELL"</span>, <span class="string">"curl -f http://tritonserver:8000/v2/health/ready"</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">shm_size:</span> <span class="string">256M</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">devices:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">driver:</span> <span class="string">nvidia</span></span><br><span class="line">              <span class="attr">count:</span> <span class="string">all</span></span><br><span class="line">              <span class="attr">capabilities:</span> [<span class="string">gpu</span>]</span><br></pre></td></tr></tbody></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>CMD 命令类型用于执行指定的命令，它将命令及其参数作为一个数组传递。在给定的示例中，CMD 命令执行的是 <code>curl -f http://minio:9000/minio/health/live</code> 命令，用于检查 MinIO 服务的健康状态。</p>
</li>
<li class="lvl-2">
<p>CMD-SHELL 命令类型用于执行指定的命令字符串。在给定的示例中，CMD-SHELL 命令执行的是 <code>curl -f http://tritonserver:8000/v2/health/ready</code> 命令，同样用于检查 Triton Server 服务的健康状态。</p>
</li>
</ul>
<p>因此，CMD 和 CMD-SHELL 的区别在于命令的传递方式，CMD 使用数组形式传递命令及其参数，而 CMD-SHELL 使用字符串形式传递命令。</p>
<h3 id="restart">restart</h3>
<p>restart 策略用于控制容器在退出后的行为。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>on-failure 是指在容器退出时，当其退出状态码不为 0（即失败）时，自动重启该容器。具体来说，它会重启那些在容器退出时返回非 0 状态码的容器。如果容器在退出时返回状态码 0，则不会自动重启该容器。</p>
</li>
<li class="lvl-2">
<p>no：容器退出时不重启容器；</p>
</li>
<li class="lvl-2">
<p>always：容器退出时总是重启容器；</p>
</li>
<li class="lvl-2">
<p>unless-stopped：容器退出时重启容器，除非容器被手动停止。</p>
</li>
</ul>
<h3 id="volume-2">volume</h3>
<figure class="highlight yml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">your-service:</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">volume</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">cppblueprint-src</span></span><br><span class="line">        <span class="attr">target:</span> <span class="string">/workspace</span></span><br><span class="line">        <span class="attr">consistency:</span> <span class="string">cached</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="config">config</h3>
<p>docker-compose config 命令用于验证并查看最终的 docker-compose 文件。当有多个 docker-compose 文件时，可以使用 -f 参数来指定多个文件。这些文件将按照它们在命令行中出现的顺序进行合并。如果在多个文件中定义了相同的服务，那么后面的定义将覆盖前面的定义。</p>
<p>合并规则如下：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>对于字典类型的字段（例如 environment，labels），它们将被深度合并。如果同一个键在多个文件中定义，那么后面的值将覆盖前面的值。</p>
</li>
<li class="lvl-2">
<p>对于列表类型的字段（例如 ports，volumes），它们将被扩展。也就是说，所有文件中的值都将被包含在最终的列表中。</p>
</li>
<li class="lvl-2">
<p>对于其他类型的字段，例如 image，command，如果在多个文件中定义，那么后面的值将覆盖前面的值。</p>
</li>
</ul>
<p>例如，如果有两个 docker-compose 文件，docker-compose.yml 和 docker-compose.override.yml，可以使用以下命令来查看最终的配置：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f docker-compose.yml -f docker-compose.override.yml config</span><br></pre></td></tr></tbody></table></figure>
<h2 id="docker-api">docker api</h2>
<p>Docker Engine 有一个 RESTful API。可以在这里找到完整的 API 文档 <a target="_blank" rel="noopener" href="https://docs.Docker.com/Engine/API/v1.40/%E8%BF%99%E6%84%8F%E5%91%B3%E7%9D%80%E7%94%B1%E4%BA%8E%E5%A4%9A%E5%85%8B%E5%BC%95%E6%93%8E%E6%9C%89%E4%B8%80%E4%B8%AA">https://docs.Docker.com/Engine/API/v1.40 / 这意味着由于多克引擎有一个</a> RESTful HTTP/S API，我们可以连接到一个远程多克引擎，甚至可以使用 curl 或 wget 命令远程运行命令，就像我们可以对任何其他基于 HTTP/S 的 API 所做的那样。</p>
<h3 id="python-client">python client</h3>
<p>python 通过包 docker 提供 api 客户端操作工具，<code>pip install docker</code></p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> docker</span><br><span class="line">client = docker.from_env()</span><br><span class="line"><span class="built_in">print</span>(client.containers.run(<span class="string">"alpine"</span>, [<span class="string">"echo"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>]))</span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/sdk/">https://docs.docker.com/engine/api/sdk/</a></p>
</li>
</ul>
<h2 id="docker-swarm">docker swarm</h2>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/">Docker Swarm</a> 是 Docker 的原生集群和编排工具，用于创建和管理 Docker 节点集群和在集群中部署服务。</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a></p>
</li>
</ul>
<h3 id="swarm-管理">swarm 管理</h3>
<p>Step 1, 初始化 Swarm 集群：首先，需要在一个节点上初始化 Swarm 集群。这个节点将成为集群的管理节点。使用以下命令初始化 Swarm：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 其中&lt;MANAGER-IP&gt;是管理节点的IP地址。</span></span><br><span class="line">docker swarm init --advertise-addr &lt;MANAGER-IP&gt;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker swarm init --advertise-addr 10.16.31.3</span><br><span class="line">Swarm initialized: current node (vw5q29giyjap87yfwjbd9t0hh) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following <span class="built_in">command</span>:</span><br><span class="line"></span><br><span class="line">    docker swarm <span class="built_in">join</span> --token SWMTKN-1-1la2dx1j0o12hk8mq0an415s637b71ujx9hfqm90c5vmi61d3v-3fcfcedql7voq0skyrj1wxson 10.16.31.3:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run <span class="string">'docker swarm join-token manager'</span> and follow the instructions.</span><br></pre></td></tr></tbody></table></figure>
<p>Step 2, 添加工作节点：初始化 Swarm 后，会得到一个命令和 token，其他节点可以使用这个命令和 token 加入 Swarm 集群。命令如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm <span class="built_in">join</span> --token &lt;TOKEN&gt; &lt;MANAGER-IP&gt;:2377</span><br></pre></td></tr></tbody></table></figure>
<p>Step 3, 从 Swarm 集群中退出</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在工作节点上执行：如果想让一个工作节点从Swarm集群中退出，可以在该节点上运行以下命令</span></span><br><span class="line">docker swarm leave</span><br><span class="line"><span class="comment"># 在管理节点上执行：如果想让一个管理节点从Swarm集群中退出，需要添加--force选项，命令如下</span></span><br><span class="line">docker swarm leave --force</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>[!CAUTION]<br>
请注意，如果 Swarm 集群只有一个管理节点，不应该让它退出，因为这将导致失去管理 Swarm 集群的能力。</p>
</blockquote>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/swarm/">https://docs.docker.com/engine/reference/commandline/swarm/</a></p>
</li>
</ul>
<h3 id="节点管理">节点管理</h3>
<p>Docker Swarm 中的节点管理主要涉及到添加节点、查看节点状态、更新节点和删除节点等操作。</p>
<p>添加节点：在初始化 Swarm 集群后，会得到一个命令和 token，其他节点可以使用这个命令和 token 加入 Swarm 集群。命令如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker swarm <span class="built_in">join</span> --token &lt;TOKEN&gt; &lt;MANAGER-IP&gt;:2377</span><br></pre></td></tr></tbody></table></figure>
<p>节点状态：可以使用以下命令查看 Swarm 集群中所有节点的状态：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker node <span class="built_in">ls</span></span><br></pre></td></tr></tbody></table></figure>
<p>更新节点：可以使用以下命令更新 Swarm 集群中的节点：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker node update &lt;NODE-ID&gt;</span><br><span class="line">docker node update &lt;NODE-ID&gt; --availiabiblity drain/active/pause</span><br></pre></td></tr></tbody></table></figure>
<p>删除节点：可以使用以下命令从 Swarm 集群中删除节点：</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首相设置节点不再被调度</span></span><br><span class="line">docker node update &lt;NODE-ID&gt; --availiabiblity drain</span><br><span class="line"><span class="comment"># 然后删除节点</span></span><br><span class="line">docker node <span class="built_in">rm</span> &lt;NODE-ID&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>label 管理:</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给节点添加label</span></span><br><span class="line">docker node update --label-add &lt;key&gt;=&lt;value&gt; &lt;NODE-ID&gt;</span><br><span class="line"><span class="comment"># 根据label部署服务</span></span><br><span class="line">docker service create --constraint <span class="string">'node.labels.&lt;key&gt;==&lt;value&gt;'</span> &lt;IMAGE&gt;</span><br><span class="line"><span class="comment"># 使用docker-compose</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | docker-compose up -f -</span></span><br><span class="line"><span class="string">version: '3'</span></span><br><span class="line"><span class="string">services:</span></span><br><span class="line"><span class="string">  web:</span></span><br><span class="line"><span class="string">    image: &lt;IMAGE&gt;</span></span><br><span class="line"><span class="string">    deploy:</span></span><br><span class="line"><span class="string">      placement:</span></span><br><span class="line"><span class="string">        constraints:</span></span><br><span class="line"><span class="string">          - node.labels.&lt;key&gt;==&lt;value&gt;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/node/">https://docs.docker.com/engine/reference/commandline/node/</a></p>
</li>
</ul>
<h3 id="服务管理">服务管理</h3>
<p>docker stack 和 docker service 都是 Docker Swarm 模式下的命令，它们用于管理和操作服务，但是它们的使用场景和功能有所不同。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>docker stack：这个命令主要用于管理和操作整个应用栈。一个应用栈可以包含多个服务，这些服务可以通过同一个 docker-compose.yml 文件定义。可以使用 docker stack deploy 命令来部署整个应用栈，或者使用 docker stack rm 来移除整个应用栈。</p>
</li>
<li class="lvl-2">
<p>docker service：这个命令主要用于管理和操作单个服务。可以使用 docker service create 命令来创建一个新的服务，或者使用 docker service update 来更新一个现有的服务。此外，还可以使用 docker service scale 来调整服务的副本数量。</p>
</li>
</ul>
<p>总的来说，docker stack 命令提供了一个更高级别的抽象，它允许一次性管理和操作整个应用栈，而 docker service 命令则提供了更细粒度的控制，它允许管理和操作单个服务。</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 部署服务</span></span><br><span class="line">docker stack deploy -c docker-compose.yml -c docker-compose.prod.yml myapp_stack</span><br><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line">docker service <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># 更新服务</span></span><br><span class="line">docker service update &lt;SERVICE-ID&gt;</span><br><span class="line"><span class="comment"># 删除服务</span></span><br><span class="line">docker service <span class="built_in">rm</span> &lt;SERVICE-ID&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="GPU">GPU</h3>
<p>将 docker runtime 默认位置为 nvidia.</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/mtzgroup/bigchem/blob/master/docs/swarm-gpus.md">https://github.com/mtzgroup/bigchem/blob/master/docs/swarm-gpus.md</a></p>
</li>
</ul>
<h3 id="docker-compose-2">docker-compose</h3>
<blockquote>
<p>[!CAUTION]<br>
docker-compose 中 depends_on,restart,deploy.resources.reservations 等资源不可用，需要单独配置.</p>
</blockquote>
<h3 id="UI">UI</h3>
<p>Docker Swarm 的管理和部署可以通过各种 UI 工具进行，以下是一些常见的选项：</p>
<ol>
<li class="lvl-3">
<p>Portainer：Portainer 是一个轻量级的管理 UI，可以用来管理 Docker、Swarm、Kubernetes 等。它提供了一个直观的界面来管理 Docker Swarm 集群，包括服务、容器、网络和卷。</p>
</li>
<li class="lvl-3">
<p>SwarmPit：SwarmPit 提供了一个简单而强大的界面来管理 Docker Swarm 集群。它支持服务的自动扩展、容器日志、服务发现等功能。</p>
</li>
<li class="lvl-3">
<p>Rancher：Rancher 是一个开源的容器管理平台，它支持 Docker Swarm、Kubernetes 等。Rancher 提供了一个全面的界面来管理和部署服务。</p>
</li>
</ol>
<p>以上工具都可以帮助更方便地管理和部署 Docker Swarm 集群。可以根据需求选择合适的工具。</p>
<h4 id="swarmpit">swarmpit</h4>
<p><a target="_blank" rel="noopener" href="https://github.com/swarmpit/swarmpit">SwarmPit</a>:Lightweight mobile-friendly Docker Swarm management UI</p>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --<span class="built_in">rm</span>   \</span><br><span class="line">    --name swarmpit-installer   \</span><br><span class="line">    --volume /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">    swarmpit/install:1.9</span><br></pre></td></tr></tbody></table></figure>
<h4 id="portainer">portainer</h4>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker volume create portainer_data</span><br><span class="line">docker run -d \</span><br><span class="line">    -p 9000:9000 \</span><br><span class="line">    --name=portainer \</span><br><span class="line">    --restart=unless-stopped \</span><br><span class="line">    -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">    -v portainer_data:/data \</span><br><span class="line">    portainer/portainer-ce</span><br></pre></td></tr></tbody></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.portainer.io/start/install-ce/server/docker/linux">https://docs.portainer.io/start/install-ce/server/docker/linux</a></p>
</li>
</ul>
<h3 id="swarm-mesh">swarm mesh</h3>
<p>swarm 默认使用的是 IPVS 提供的四层模型请求负载均衡消费模式。即和默认非 swarm 模式下单独 docker 使用同一一个网络模型.</p>
<p>当有其它需求实时，推荐使用 traefik 等开源方案.</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://semaphoreci.com/community/tutorials/consuming-services-in-a-docker-swarm-mode-cluster">https://semaphoreci.com/community/tutorials/consuming-services-in-a-docker-swarm-mode-cluster</a></p>
</li>
</ul>
<h2 id="docker-proxy">docker proxy</h2>
<p>在容器环境中配置代理环境变量，配置<a target="_blank" rel="noopener" href="https://github.com/msclock/gitlab-ci-templates/blob/main/templates/common.yml">示例</a></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>HTTP_PROXY</p>
</li>
<li class="lvl-2">
<p>http_proxy</p>
</li>
<li class="lvl-2">
<p>HTTPS_PROXY</p>
</li>
<li class="lvl-2">
<p>https_proxy</p>
</li>
<li class="lvl-2">
<p>NO_PROXY</p>
</li>
<li class="lvl-2">
<p>no_proxy</p>
</li>
<li class="lvl-2">
<p>ALL_PROXY</p>
</li>
<li class="lvl-2">
<p>all_proxy</p>
</li>
</ul>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy">https://docs.docker.com/config/daemon/systemd/#httphttps-proxy</a></p>
</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Msclock
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://msclock.github.io/posts/7d9a968e/" title="Docker 疑难问题">https://msclock.github.io/posts/7d9a968e/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>

          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/2a2a7e8a/" rel="prev" title="flutter">
                  <i class="fa fa-angle-left"></i> flutter
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/2985153235/" rel="next" title="ssh 实践">
                  ssh 实践 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81Njg4MS8zMzM0NQ=="></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Msclock</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">422k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:24</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/msclock" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/comments.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/utils.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/motion.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/sidebar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/next-boot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/pjax.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/third-party/search/local-search.min.js"></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.3.0/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/third-party/tags/pdf.min.js"></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@11.4.0/dist/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/third-party/tags/mermaid.min.js"></script>



  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/third-party/pace.min.js"></script>


  




  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://msclock.github.io/posts/7d9a968e/"}</script>
  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/third-party/quicklink.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.21.1/source/js/third-party/comments/livere.min.js"></script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
