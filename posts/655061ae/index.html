<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-circle.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous" defer></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"msclock.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":true,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"github-dark"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"livere","storage":true,"lazyload":false,"nav":null,"activeClass":"livere"},"stickytabs":true,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/config.min.js" defer></script>

    <meta name="description" content="resource    资源 组织 类型     devops-exercises bregman-arie 基础    k8s 什么是 k8s   开源的容器编排工具   由google开发   帮助在不同的部署环境中管理容器应用   k8s 解决的问题   将传统铁板一块的应用转为微服务管理   增加容器的使用便利   高效管理成千上百的容器的能力   k8s 提供的编排功能   高可用且无">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s">
<meta property="og:url" content="https://msclock.github.io/posts/655061ae/index.html">
<meta property="og:site_name" content="Live in the present">
<meta property="og:description" content="resource    资源 组织 类型     devops-exercises bregman-arie 基础    k8s 什么是 k8s   开源的容器编排工具   由google开发   帮助在不同的部署环境中管理容器应用   k8s 解决的问题   将传统铁板一块的应用转为微服务管理   增加容器的使用便利   高效管理成千上百的容器的能力   k8s 提供的编排功能   高可用且无">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/224032480.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/232926883.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/233246495.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/233722615.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/234254143.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/234920715.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/235526389.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/235806623.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/000713816.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/220321961.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/220901029.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/221238833.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/221757290.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/222351496.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/224919614.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/225016142.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/225210493.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/230523187.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221023/230750437.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20230421/065015394.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20230421/065604918.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20230421/065816653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20230421/070100196.png">
<meta property="og:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20230421/070244993.png">
<meta property="article:published_time" content="2022-09-11T13:13:08.000Z">
<meta property="article:modified_time" content="2025-07-01T01:39:50.620Z">
<meta property="article:author" content="Msclock">
<meta property="article:tag" content="cpp,hexo,blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/msclock/images/main/images/20221022/224032480.png">


<link rel="canonical" href="https://msclock.github.io/posts/655061ae/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://msclock.github.io/posts/655061ae/","path":"posts/655061ae/","title":"k8s"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s | Live in the present</title>
  








  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@next-theme/pjax@0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous" defer></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/utils.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/motion.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/sidebar.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/next-boot.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/pjax.min.js" defer></script>

  <script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.1/dist/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous" defer></script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/third-party/search/local-search.min.js" defer></script>

  <script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdn.jsdelivr.net/npm/pdfobject@2.3.1/pdfobject.min.js","integrity":"sha256-jI72I8ZLVflVOisZIOaLvRew3tyvzeu6aZXFm7P7dEo="},"url":"/lib/pdf/web/viewer.html"}</script>
  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/third-party/tags/pdf.min.js" defer></script>

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"neutral","dark":"neutral"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@11.5.0/dist/mermaid.min.js","integrity":"sha256-2obLuIPcceEhkE3G09G33hBdmE55ivVcZUlcKcGNHjU="}}</script>
  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/third-party/tags/mermaid.min.js" defer></script>



  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/third-party/pace.min.js" defer></script>


  




  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous" defer></script>
  <script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":3000,"priority":true,"url":"https://msclock.github.io/posts/655061ae/"}</script>
  <script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/third-party/quicklink.min.js" defer></script>

  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>.darkmode--activated{--body-bg-color:#282828;--content-bg-color:#333;--card-bg-color:#555;--text-color:#ccc;--blockquote-color:#bbb;--link-color:#ccc;--link-hover-color:#eee;--brand-color:#ddd;--brand-hover-color:#ddd;--table-row-odd-bg-color:#282828;--table-row-hover-bg-color:#363636;--menu-item-bg-color:#555;--btn-default-bg:#222;--btn-default-color:#ccc;--btn-default-border-color:#555;--btn-default-hover-bg:#666;--btn-default-hover-color:#ccc;--btn-default-hover-border-color:#666;--highlight-background:#282b2e;--highlight-foreground:#a9b7c6;--highlight-gutter-background:#34393d;--highlight-gutter-foreground:#9ca9b6}.darkmode--activated img{opacity:.75}.darkmode--activated img:hover{opacity:.9}.darkmode--activated code{color:#69dbdc;background:0 0}button.darkmode-toggle{z-index:9999}.darkmode-ignore,img{display:flex!important}.beian img{display:inline-block!important}</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Live in the present</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Msclock's Notes</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">32</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">2</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">50</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#resource"><span class="nav-number">1.</span> <span class="nav-text">resource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s"><span class="nav-number">2.</span> <span class="nav-text">k8s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#QA"><span class="nav-number">2.1.1.</span> <span class="nav-text">QA</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">2.2.</span> <span class="nav-text">架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-%E4%B8%BB%E8%A6%81%E7%BB%84%E4%BB%B6"><span class="nav-number">2.3.</span> <span class="nav-text">k8s 主要组件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Node-Pod"><span class="nav-number">2.3.1.</span> <span class="nav-text">Node &amp; Pod</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Service-Ingress"><span class="nav-number">2.3.2.</span> <span class="nav-text">Service &amp; Ingress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ConfigMap-Secret"><span class="nav-number">2.3.3.</span> <span class="nav-text">ConfigMap &amp; Secret</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Volume"><span class="nav-number">2.3.4.</span> <span class="nav-text">Volume</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Deploment-StatefulSet"><span class="nav-number">2.3.5.</span> <span class="nav-text">Deploment &amp; StatefulSet</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-%E9%85%8D%E7%BD%AE"><span class="nav-number">2.4.</span> <span class="nav-text">k8s 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-yaml-%E5%AE%8C%E6%95%B4%E9%85%8D%E7%BD%AE"><span class="nav-number">2.5.</span> <span class="nav-text">k8s yaml 完整配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Namespace"><span class="nav-number">2.6.</span> <span class="nav-text">Namespace</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-Namespace"><span class="nav-number">2.6.1.</span> <span class="nav-text">为什么用 Namespace</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8%E7%A9%BA%E9%97%B4%E4%B8%AD%E5%88%9B%E5%BB%BA%E7%BB%84%E4%BB%B6"><span class="nav-number">2.6.2.</span> <span class="nav-text">在空间中创建组件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ingress"><span class="nav-number">2.7.</span> <span class="nav-text">Ingress</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-Ingress"><span class="nav-number">2.7.1.</span> <span class="nav-text">配置 Ingress</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ingress-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95"><span class="nav-number">2.7.2.</span> <span class="nav-text">Ingress 常用配置方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HPA%E3%80%81KPA"><span class="nav-number">2.8.</span> <span class="nav-text">HPA、KPA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96-in-k8s"><span class="nav-number">2.9.</span> <span class="nav-text">持久化 in k8s</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E5%BA%A6%E8%8A%82%E7%82%B9"><span class="nav-number">2.10.</span> <span class="nav-text">调度节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GPU"><span class="nav-number">2.11.</span> <span class="nav-text">GPU</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reference"><span class="nav-number">2.12.</span> <span class="nav-text">reference</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#minikube"><span class="nav-number">3.</span> <span class="nav-text">minikube</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-2"><span class="nav-number">3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="nav-number">3.2.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%BA%94%E7%94%A8"><span class="nav-number">3.3.</span> <span class="nav-text">运行应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%A4%9A%E9%9B%86%E7%BE%A4%E6%A8%A1%E6%8B%9F"><span class="nav-number">3.4.</span> <span class="nav-text">本地多集群模拟</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kind"><span class="nav-number">4.</span> <span class="nav-text">kind</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gpu-support"><span class="nav-number">4.1.</span> <span class="nav-text">gpu support</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubectl"><span class="nav-number">5.</span> <span class="nav-text">kubectl</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-3"><span class="nav-number">5.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-2"><span class="nav-number">5.2.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">5.3.</span> <span class="nav-text">持久化存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pod-%E8%B0%83%E8%AF%95"><span class="nav-number">5.4.</span> <span class="nav-text">pod 调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k3d"><span class="nav-number">6.</span> <span class="nav-text">k3d</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gpu-workload"><span class="nav-number">6.1.</span> <span class="nav-text">gpu workload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kustomize"><span class="nav-number">7.</span> <span class="nav-text">kustomize</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-4"><span class="nav-number">7.1.</span> <span class="nav-text">安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helm"><span class="nav-number">8.</span> <span class="nav-text">helm</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5"><span class="nav-number">8.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-5"><span class="nav-number">8.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-3"><span class="nav-number">8.3.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8C%85"><span class="nav-number">8.4.</span> <span class="nav-text">打包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rancher"><span class="nav-number">9.</span> <span class="nav-text">rancher</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-6"><span class="nav-number">9.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#App"><span class="nav-number">9.2.</span> <span class="nav-text">App</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gpu"><span class="nav-number">9.3.</span> <span class="nav-text">gpu</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rke"><span class="nav-number">10.</span> <span class="nav-text">rke</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k3s"><span class="nav-number">11.</span> <span class="nav-text">k3s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-7"><span class="nav-number">11.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Quickstart"><span class="nav-number">11.1.1.</span> <span class="nav-text">Quickstart</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-with-autok3s"><span class="nav-number">11.1.2.</span> <span class="nav-text">Run with autok3s</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-k3s-in-docker"><span class="nav-number">11.1.3.</span> <span class="nav-text">Run k3s in docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-k3s-Based-on-docker"><span class="nav-number">11.1.4.</span> <span class="nav-text">Run k3s Based on docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-k3s-Based-on-containerd"><span class="nav-number">11.1.5.</span> <span class="nav-text">Run k3s Based on containerd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#QA-2"><span class="nav-number">11.1.6.</span> <span class="nav-text">QA</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BF%E9%97%AE%E9%9B%86%E7%BE%A4"><span class="nav-number">11.2.</span> <span class="nav-text">访问集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gpu-on-k3s"><span class="nav-number">11.3.</span> <span class="nav-text">gpu on k3s</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Based-on-docker"><span class="nav-number">11.3.1.</span> <span class="nav-text">Based on docker</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Based-on-containerd"><span class="nav-number">11.3.2.</span> <span class="nav-text">Based on containerd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-with-helm"><span class="nav-number">11.3.3.</span> <span class="nav-text">Enable with helm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Test"><span class="nav-number">11.3.4.</span> <span class="nav-text">Test</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k3s-registry-mirror"><span class="nav-number">11.4.</span> <span class="nav-text">k3s registry mirror</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#traefik"><span class="nav-number">11.5.</span> <span class="nav-text">traefik</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#crictl"><span class="nav-number">11.6.</span> <span class="nav-text">crictl</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-4"><span class="nav-number">11.6.1.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%80%93runtime-endpoint"><span class="nav-number">11.6.2.</span> <span class="nav-text">–runtime-endpoint</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rke2"><span class="nav-number">12.</span> <span class="nav-text">rke2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-8"><span class="nav-number">12.1.</span> <span class="nav-text">安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#istio"><span class="nav-number">13.</span> <span class="nav-text">istio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-Mesh-%E6%BC%94%E5%8C%96"><span class="nav-number">13.1.</span> <span class="nav-text">Service Mesh 演化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-Mesh"><span class="nav-number">13.2.</span> <span class="nav-text">Service Mesh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#istio-2"><span class="nav-number">13.3.</span> <span class="nav-text">istio</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#istio-%E5%AE%9A%E4%B9%89"><span class="nav-number">13.3.1.</span> <span class="nav-text">istio 定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#istio-%E6%A0%B8%E5%BF%83%E8%B5%84%E6%BA%90-CRD"><span class="nav-number">13.3.2.</span> <span class="nav-text">istio 核心资源 CRD</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="nav-number">13.3.3.</span> <span class="nav-text">可观测性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%9E%B6%E6%9E%84"><span class="nav-number">13.3.4.</span> <span class="nav-text">安全架构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-9"><span class="nav-number">13.3.5.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Virtucal-Service-%E5%92%8C-Destination-Rule"><span class="nav-number">13.3.6.</span> <span class="nav-text">Virtucal Service 和 Destination Rule</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#knative"><span class="nav-number">14.</span> <span class="nav-text">knative</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#knative-%E6%96%87%E6%A1%A3"><span class="nav-number">14.1.</span> <span class="nav-text">knative 文档</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#traefik-2"><span class="nav-number">15.</span> <span class="nav-text">traefik</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#traefik-%E7%A4%BA%E4%BE%8B"><span class="nav-number">15.1.</span> <span class="nav-text">traefik 示例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#docker-compose-%E7%A4%BA%E4%BE%8B"><span class="nav-number">15.1.1.</span> <span class="nav-text">docker-compose 示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#k8s-%E7%A4%BA%E4%BE%8B"><span class="nav-number">15.1.2.</span> <span class="nav-text">k8s 示例</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#opentelemetry"><span class="nav-number">16.</span> <span class="nav-text">opentelemetry</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Msclock"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Msclock</p>
  <div class="site-description" itemprop="description">That life is reality.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">32</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/msclock" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;msclock" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:msclock@qq.com" title="E-Mail → mailto:msclock@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://plus.google.com/msclockg" title="Google → https:&#x2F;&#x2F;plus.google.com&#x2F;msclockg" rel="noopener me" target="_blank"><i class="fab fa-google fa-fw"></i>Google</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://msclock.github.io/posts/655061ae/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Msclock">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Live in the present">
      <meta itemprop="description" content="That life is reality.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="k8s | Live in the present">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-11 21:13:08" itemprop="dateCreated datePublished" datetime="2022-09-11T21:13:08+08:00">2022-09-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-01 09:39:50" itemprop="dateModified" datetime="2025-07-01T09:39:50+08:00">2025-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/develop/" itemprop="url" rel="index"><span itemprop="name">develop</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>42k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>38 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><!--
k8s:
    aliyun 入门:https://developer.aliyun.com/learning/course/51?spm=a2c6h.12873639.article-detail.124.377a3155x8UJpu&scm=20140722.ID_community@@course@@51._.ID_community@@course@@51-OR_rec-V_1-RL_community@@article@@742566

https://thenewstack.io/tutorial-deploy-the-nvidia-gpu-operator-on-kubernetes-based-on-containerd-runtime/
 -->
<h2 id="resource">resource</h2>
<table>
<thead>
<tr>
<th>资源</th>
<th>组织</th>
<th>类型</th>
</tr>
</thead>
<tbody>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/bregman-arie/devops-exercises/blob/master/topics/kubernetes/README.md">devops-exercises</a></td>
<td>bregman-arie</td>
<td>基础</td>
</tr>
</tbody>
</table>
<h2 id="k8s">k8s</h2>
<p>什么是 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/home/">k8s</a></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>开源的容器编排工具</p>
</li>
<li class="lvl-2">
<p>由google开发</p>
</li>
<li class="lvl-2">
<p>帮助在不同的部署环境中管理容器应用</p>
</li>
</ul>
<p>k8s 解决的问题</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>将传统铁板一块的应用转为微服务管理</p>
</li>
<li class="lvl-2">
<p>增加容器的使用便利</p>
</li>
<li class="lvl-2">
<p>高效管理成千上百的容器的能力</p>
</li>
</ul>
<p>k8s 提供的编排功能</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>高可用且无关机时延</p>
</li>
<li class="lvl-2">
<p>可扩展性或高性能</p>
</li>
<li class="lvl-2">
<p>容灾,备份和还原</p>
</li>
</ul>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/">https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/</a></p>
</li>
</ul>
<span id="more"></span>
<h3 id="安装">安装</h3>
<p>docker runtime 安装 k8s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># centos</span></span><br><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"><span class="comment"># ubuntu</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install ca-certificates curl gnupg</span><br><span class="line">install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"><span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=&quot;</span>$(dpkg --print-architecture)<span class="string">&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  &quot;</span>$(. /etc/os-release &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)<span class="string">&quot; stable&quot;</span> | <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">apt update &amp;&amp; apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"><span class="comment"># debian</span></span><br><span class="line">apt-get update</span><br><span class="line">apt-get install ca-certificates curl gnupg</span><br><span class="line">install -m 0755 -d /etc/apt/keyrings</span><br><span class="line">curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class="line"><span class="built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=&quot;</span>$(dpkg --print-architecture)<span class="string">&quot; signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \</span></span><br><span class="line"><span class="string">  &quot;</span>$(. /etc/os-release &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$VERSION_CODENAME</span>&quot;</span>)<span class="string">&quot; stable&quot;</span> | <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line">apt update &amp;&amp; apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置docker</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt;/etc/docker/daemon.json&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;default-runtime&quot;: &quot;nvidia&quot;,</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [</span></span><br><span class="line"><span class="string">    &quot;native.cgroupdriver=systemd&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;runtimes&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;nvidia&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;args&quot;: [],</span></span><br><span class="line"><span class="string">      &quot;path&quot;: &quot;nvidia-container-runtime&quot;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;builder&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;gc&quot;: &#123;</span></span><br><span class="line"><span class="string">      &quot;defaultKeepStorage&quot;: &quot;20GB&quot;,</span></span><br><span class="line"><span class="string">      &quot;enabled&quot;: true</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;experimental&quot;: true,</span></span><br><span class="line"><span class="string">  &quot;features&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;buildkit&quot;: true</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;insecure-registries&quot;: [</span></span><br><span class="line"><span class="string">    &quot;harbor.baijiayun.com&quot;,</span></span><br><span class="line"><span class="string">    &quot;docker.huaguisystems.com&quot;</span></span><br><span class="line"><span class="string">  ],</span></span><br><span class="line"><span class="string">  &quot;registry-mirrors&quot;: [</span></span><br><span class="line"><span class="string">    &quot;https://docker.mirrors.sjtug.sjtu.edu.cn&quot;,</span></span><br><span class="line"><span class="string">    &quot;https://reg-mirror.qiniu.com&quot;</span></span><br><span class="line"><span class="string">  ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 k8s 软件工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Update sysctl settings for Kubernetes networking</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;/etc/sysctl.d/kubernetes.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置k8s源并安装</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># centos</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">yum updatee &amp;&amp; yum install -y kubelet kubeadm kubectl</span><br><span class="line"><span class="comment"># debian/ubuntu</span></span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> | <span class="built_in">tee</span> -a /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"><span class="comment"># 国内</span></span><br><span class="line">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&quot;</span> | <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line">apt update &amp;&amp; apt install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选:为kubelet 关闭交换优化性能</span></span><br><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># centos用于临时关闭 SELinux 安全策略</span></span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选:为了实现 docker 使用的 cgroup-driver 和 kubelet 使用的 cgroup 一致,根据具体情况修改kubelet 配置</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=systemd&quot;&#x27;</span> | <span class="built_in">tee</span> -a /etc/default/kubelet</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<p>配置k8s集群</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看配置需要的k8s镜像</span></span><br><span class="line">kubeadm config images list</span><br><span class="line">kubeadm config images list | xargs docker pull</span><br><span class="line"></span><br><span class="line">kubeadm init \</span><br><span class="line">    --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">    <span class="comment"># 根据网络配置api及service</span></span><br><span class="line">    <span class="comment"># --pod-network-cidr=10.244.0.0/16 \</span></span><br><span class="line">    <span class="comment"># --apiserver-advertise-address=10.16.8.135 \</span></span><br><span class="line">    <span class="comment"># --service-cidr=10.96.0.0/16</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用阿里云镜像源</span></span><br><span class="line">kubeadm config images pull \</span><br><span class="line">    --image-repository registry.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更换时区到国内</span></span><br><span class="line"><span class="built_in">ln</span> -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line"><span class="comment">#安装ntpdate工具</span></span><br><span class="line">apt-get install ntpdate</span><br><span class="line"><span class="comment">#设置系统时间与网络时间同步</span></span><br><span class="line">ntpdate cn.pool.ntp.org</span><br><span class="line"><span class="comment">#然后将时间更新到硬件上：</span></span><br><span class="line">hwclock --systohc</span><br></pre></td></tr></table></figure>
<p>containerd安装k8s</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置containerd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为kubelet 关闭交换优化性能</span></span><br><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># Update sysctl settings for Kubernetes networking</span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;/etc/sysctl.d/kubernetes.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line">curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | <span class="built_in">sudo</span> apt-key add -</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> | <span class="built_in">tee</span> -a /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line">apt update &amp;&amp; apt install -y kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line">containerd config default | <span class="built_in">tee</span> /etc/containerd/config.toml</span><br><span class="line">systemctl restart containerd</span><br><span class="line">systemctl status containerd</span><br><span class="line"><span class="comment"># https://www.youtube.com/watch?v=k3iexxiYPI8</span></span><br></pre></td></tr></table></figure>
<p>参考:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/396775382">0基础搭建gpu k8s</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a2e44fe93f88">kubeadm初始化踩坑</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/justmeandopensource/kubernetes">https://github.com/justmeandopensource/kubernetes</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/justmeandopensource/kubernetes/blob/master/docs/install-cluster-centos-7.md">https://github.com/justmeandopensource/kubernetes/blob/master/docs/install-cluster-centos-7.md</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/justmeandopensource/kubernetes/blob/master/docs/install-cluster-ubuntu-20.md">https://github.com/justmeandopensource/kubernetes/blob/master/docs/install-cluster-ubuntu-20.md</a></p>
</li>
</ul>
<h4 id="QA">QA</h4>
<h5 id="kubelet-service-failed">kubelet.service failed</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">   Active: activating (auto-restart) (Result: exit-code) since Wed 2023-07-19 11:44:14 CST; 7s ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line">  Process: 2856971 ExecStart=/usr/bin/kubelet (code=exited, status=1/FAILURE)</span><br><span class="line"> Main PID: 2856971 (code=exited, status=1/FAILURE)</span><br><span class="line">    Tasks: 0</span><br><span class="line">   Memory: 0B</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line"></span><br><span class="line">Jul 19 11:44:14 localhost.localdomain systemd[1]: Unit kubelet.service entered failed state.</span><br><span class="line">Jul 19 11:44:14 localhost.localdomain systemd[1]: kubelet.service failed.</span><br></pre></td></tr></table></figure>
<p>kubelet 启动失败<br>
kubelet服务启动失败。可以通过查看kubelet的日志来获取更多信息，使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">journalctl -fu kubelet</span><br><span class="line">journalctl -xe</span><br></pre></td></tr></table></figure>
<h5 id="validate-service-connection-CRI-v1-runtime-API-is-not-implemented">validate service connection: CRI v1 runtime API is not implemented</h5>
<p>错误日志:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# containerd --version</span><br><span class="line">containerd containerd.io 1.6.21 3dce8eb055cbb6872793272b4f20ed16117344f8</span><br><span class="line">[root@localhost ~]# docker info |grep Cgroup</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line">WARNING: bridge-nf-call-ip6tables is disabled</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line">[root@localhost ~]# <span class="built_in">cat</span> /var/lib/kubelet/kubeadm-flags.env</span><br><span class="line">--container-runtime=docker</span><br><span class="line">[root@localhost ~]# kubeadm init --pod-network-cidr=10.244.0.0/16</span><br><span class="line">[init] Using Kubernetes version: v1.27.3</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">        [WARNING Swap]: swap is enabled; production deployments should <span class="built_in">disable</span> swap unless testing the NodeSwap feature gate of the kubelet</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">        [ERROR CRI]: container runtime is not running: output: <span class="keyword">time</span>=<span class="string">&quot;2023-07-19T15:29:19+08:00&quot;</span> level=fatal msg=<span class="string">&quot;validate service connection: CRI v1 runtime API is not implemented for endpoint \&quot;unix:///var/run/containerd/containerd.sock\&quot;: rpc error: code = Unimplemented desc = unknown service runtime.v1.RuntimeService&quot;</span></span><br><span class="line">, error: <span class="built_in">exit</span> status 1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>解决1: 将containerd配置文件 /etc/containerd/config.toml 的<code>containerd.toml中disabled_plugins = [&quot;cri&quot;]</code>项<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/602626745">注释</a></p>
<blockquote>
<p>[!TIP]<br>
cri 是 Container Runtime Interface 的缩写，这是 Kubernetes 用来与容器运行时进行交互的接口。如果在 containerd.toml 文件中禁用了 cri，那么 containerd 将无法作为 Kubernetes 的容器运行时使用.</p>
</blockquote>
<p>解决2: 使用Docker作为其容器运行时。可以通过编辑/etc/default/kubelet文件来完成这个操作。在这个文件中，需要添加或修改以下行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_EXTRA_ARGS=--container-runtime=docker</span><br></pre></td></tr></table></figure>
<p>然后，重新启动kubelet服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h5 id="如何确定k8s运行时">如何确定k8s运行时</h5>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe nodes | grep <span class="string">&#x27;Container Runtime Version&#x27;</span></span><br></pre></td></tr></table></figure>
<p>基于docker为: <code>Container Runtime Version:  docker://24.0.4</code><br>
基于containerd为: <code>Container Runtime Version:  containerd://1.7.1-k3s1</code></p>
<h3 id="架构">架构</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>整体架构图<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/224032480.png" alt="k8s arch."></p>
</li>
<li class="lvl-2">
<p>控制面架构图<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/232926883.png" alt="image."></p>
</li>
<li class="lvl-2">
<p>多控制面及多节点架构<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/233246495.png" alt="image."></p>
</li>
</ul>
<h3 id="k8s-主要组件">k8s 主要组件</h3>
<h4 id="Node-Pod">Node &amp; Pod</h4>
<p>容器的抽象</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>pod 是 k8s 最小单元</p>
</li>
<li class="lvl-2">
<p>pod 是基于容器的抽象</p>
</li>
<li class="lvl-2">
<p>通常一个 pod 只包含一个应用</p>
</li>
<li class="lvl-2">
<p>每个 pod 都有 ip,当 pod 挂掉时,重启的 pod 会生成新的 ip.</p>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/233722615.png" alt="image."></p>
<h4 id="Service-Ingress">Service &amp; Ingress</h4>
<p>容器间通信</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>service 持有不变的 ip.</p>
</li>
<li class="lvl-2">
<p>service 声明周期和 Pod 不是唯一绑定关系.</p>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/234254143.png" alt="image."></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ingress 为服务提供了统一的访问方式</p>
</li>
<li class="lvl-2">
<p>ingress 屏蔽了 ip 及 port 的传统方式</p>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/234920715.png" alt="image."></p>
<h4 id="ConfigMap-Secret">ConfigMap &amp; Secret</h4>
<p>容器运行外部配置</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>ConfigMap 提供了容器外部配置管理方式</p>
</li>
<li class="lvl-2">
<p>Secret 提供加密数据的配置,可在 Deployment/Pod中引用<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/235526389.png" alt="image."></p>
</li>
</ul>
<h4 id="Volume">Volume</h4>
<p>数据持久化</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>用于提供数据持久化配置</p>
</li>
<li class="lvl-2">
<p>本地机器,远程或集群外部位置<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221022/235806623.png" alt="image."></p>
</li>
</ul>
<h4 id="Deploment-StatefulSet">Deploment &amp; StatefulSet</h4>
<p>提供容器副本部署，deployment 下所有配置都由k8s处理</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Deploment 提供了多次多节点部署的能力(replica)</p>
</li>
<li class="lvl-2">
<p>Deploment 节点间由svc提供统一访问ip</p>
</li>
<li class="lvl-2">
<p>Deploment 多节点间提供了负载均衡能力</p>
</li>
<li class="lvl-2">
<p>StatefulSet 用于部署状态应用,如 MySQL,MonogDB,ES</p>
</li>
<li class="lvl-2">
<p>StatefulSet 部署 DB 并不容易,通常部署于 k8s 集群外<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/000713816.png" alt="image."></p>
</li>
</ul>
<h3 id="k8s-配置">k8s 配置</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>kubctl k8s cli</p>
</li>
<li class="lvl-2">
<p>yaml 配置声明模板</p>
</li>
<li class="lvl-2">
<p>etcd 保存了所有的 k8s 组件当前状态</p>
</li>
<li class="lvl-2">
<p>每个配置由3个部分组成 <strong>metadata</strong>, <strong>specification</strong>, <strong>status</strong></p>
</li>
<li class="lvl-2">
<p>status 由 k8s 从 控制面的 etcd 拉取结果 和 metadata/specification 对比生成</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1)metadata of configuration</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="comment"># 2)specification of the kind</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line"><span class="comment"># 3)status generated and added by k8s</span></span><br></pre></td></tr></table></figure>
<h3 id="k8s-yaml-完整配置">k8s yaml 完整配置</h3>
<p>流量请求路径</p>
<blockquote>
<p>browser -&gt; (webapp external service) -&gt; webapp(pod) -&gt; (mongodb internal service) -&gt; mongodb(pod)</p>
</blockquote>
<p>配置文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.configmap: mongo-config.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># config map name</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-config</span></span><br><span class="line"><span class="comment"># key-value format</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># mongo service and endpoint</span></span><br><span class="line">  <span class="attr">mongo-url:</span> <span class="string">mongo-service</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 2.secret: mongo-secret.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span> <span class="comment"># base64-encoded</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mongo-user:</span> <span class="string">bW9uZ291c2Vy</span> <span class="comment"># echo -n mongouser | base64</span></span><br><span class="line">  <span class="attr">mongo-password:</span> <span class="string">bW9uZ29wYXNzd29yZA==</span> <span class="comment"># echo -n mongopassword | base64</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.mongo deployment: mongo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-deployment</span></span><br><span class="line">  <span class="comment"># 1.can naming any k8s component a label</span></span><br><span class="line">  <span class="comment"># 2.label are key/value pairs</span></span><br><span class="line">  <span class="comment"># 3.identifier to a collection</span></span><br><span class="line">  <span class="comment"># 4.key app is used to matched in selector to connection between deployments and pods(connecting pods to deploments)</span></span><br><span class="line">  <span class="comment"># 5.connecting services to deployments</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line">  <span class="comment"># 1.blueprint for pods</span></span><br><span class="line">  <span class="comment"># 2.apply to pod</span></span><br><span class="line">  <span class="comment"># 3.has its own &quot;metadata&quot; and &quot;spec&quot; section and configure for pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mongo:5.0</span> <span class="comment"># which image</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">27017</span></span><br><span class="line">        <span class="comment"># image init environment</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_USERTNAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="comment"># same as mongo-secret of memtadata in mongo-secret.yaml</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">              <span class="comment"># same as mongo-user of data in mongo-secret.yaml</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mongo-user</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="comment"># same as mongo-secret of memtadata in mongo-secret.yaml</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">              <span class="comment"># same as mongo-password of data in mongo-secret.yaml</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mongo-password</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 4.mongo service: mongo.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># same as mongo-url in configmap to define the service url to mongo</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># select pods to forwaord the request to service(connecting services to deployments)</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># same as app in template connecting service to Pods</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongo</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="comment"># request-&gt; (port:27017)mongo service -&gt; (targetPort:27017)pod(contianerPort:27017)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="comment"># service port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">      <span class="comment"># contianerPort of Deployment</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">27017</span> <span class="comment"># same as contianerPort in template</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 3.webapp deployment: webapp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-deployment</span></span><br><span class="line">  <span class="comment"># 1.can naming any k8s component a label</span></span><br><span class="line">  <span class="comment"># 2.label are key/value pairs</span></span><br><span class="line">  <span class="comment"># 3.identifier to a collection</span></span><br><span class="line">  <span class="comment"># 4.key app is used to matched in selector to connection between deployments and pods</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">webapp</span></span><br><span class="line">  <span class="comment"># main port: blueprint for pods</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># has its own &quot;metadata&quot; and &quot;spec&quot; section and configure for pod</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">webapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webapp</span></span><br><span class="line">        <span class="comment"># which image</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nanajanashia/k8s-demo-app:v1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">mongo-user</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER_PWD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">            <span class="attr">key:</span> <span class="string">mongo-password</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">configMapKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mongo-config</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">mongo-url</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 4.webapp service: webapp.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># same as mongo-url in configmap</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">webapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># Default = ClusterIp (an internal service)</span></span><br><span class="line">  <span class="comment"># NodePort here,NodePort Service is accessible on each worker node&#x27;s ip address</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="comment"># select pods to forwaord the request to service</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="comment"># same as app in template connecting service to Pods</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">webapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="comment"># request-&gt; (port:3000)webapp service -&gt; (targetPort:3000)pod(contianerPort:3000)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="comment"># service port</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="comment"># contianerPort of Deployment</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">3000</span> <span class="comment"># same as contianerPort in template</span></span><br><span class="line">      <span class="comment"># expose the service on each node&#x27;s ip at a static port &lt;NodeIP&gt;:&lt;NodePort&gt;(here 3000:30100)</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30100</span> <span class="comment"># 30000-32768</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f mongo-config.yaml</span><br><span class="line">kubectl apply -f mongo-secret.yaml</span><br><span class="line">kubectl apply -f mongo.yaml</span><br><span class="line">kubectl apply -f webapp.yaml</span><br><span class="line"><span class="comment"># interacting with k8s clusuter</span></span><br><span class="line">kubectl get all</span><br><span class="line">kubectl get configmap</span><br><span class="line">kubectl get secret</span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl get --<span class="built_in">help</span></span><br><span class="line">kubectl describe service webapp-service</span><br><span class="line">kubectl describe pod &lt; pod name &gt;</span><br><span class="line">kubectl logs &lt; pod name &gt; -f</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl get node</span><br><span class="line">kubectl get node -o wide <span class="comment"># It can be accessed in a browser at address internal-ip:30100</span></span><br></pre></td></tr></table></figure>
<h3 id="Namespace">Namespace</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>提供以名字空间的方式管理资源</p>
</li>
<li class="lvl-2">
<p>每个名字空间需要定义自己的configmap，不同空间通过service访问</p>
</li>
<li class="lvl-2">
<p>default 默认提供的名字空间，默认创建的资源都位于该空间下。</p>
</li>
<li class="lvl-2">
<p>kube-system 不要改动或创建该空间，提供了系统处理，master, kubectl 处理</p>
</li>
<li class="lvl-2">
<p>kube-public 提供了包含集群信息的 configMap 信息</p>
</li>
<li class="lvl-2">
<p>kube-node-lease 提供了感知节点心跳、节点可用</p>
</li>
</ul>
<p>通过 kubectl 创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create namespace [namespace name]:创建名字空间</span></span><br><span class="line">kubectl create namespaec my-ns</span><br></pre></td></tr></table></figure>
<p>通过配置文件创建</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersioni:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-configmap</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">my-ns</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">db_url:</span> <span class="string">mysql-service.database</span></span><br></pre></td></tr></table></figure>
<h4 id="为什么用-Namespace">为什么用 Namespace</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>结构化管理组件</p>
</li>
<li class="lvl-2">
<p>团队间避免冲突</p>
</li>
<li class="lvl-2">
<p>共享服务</p>
</li>
<li class="lvl-2">
<p>命名空间限制访问及资源</p>
</li>
</ul>
<h4 id="在空间中创建组件">在空间中创建组件</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>当未指定空间时在默认空间创建</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f mysql-configmap.yaml</span><br><span class="line">kubectl get configmap</span><br><span class="line"><span class="comment"># 获取默认空间中的 configmap</span></span><br><span class="line">kubectl get configmap -n default</span><br></pre></td></tr></table></figure>
<h3 id="Ingress">Ingress</h3>
<p>避免 service ip 及 port 暴露</p>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/220321961.png" alt="image."></p>
<p>External Service：通过分配 external IP 给服务(nodePort of ports in Service)，使用 ip:port 外部访问</p>
<p>Ingress: 通过分配 routing 规则推动请求到内部服务(internal service)，这里http只代表推动请求<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/220901029.png" alt="image."><br>
Host: 需为合理的域名地址，映射域名地址到节点IP为入口点<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/221238833.png" alt="image."></p>
<h4 id="配置-Ingress">配置 Ingress</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>匹配所有映射规则，可配置单个 domain 映射多服务(多个path)或多 domain 映射规则</p>
</li>
<li class="lvl-2">
<p>管理所有重定向</p>
</li>
<li class="lvl-2">
<p>集群入口控制</p>
</li>
<li class="lvl-2">
<p>大多是由第三方实现，云服务商提供 Ingress 访问（自有虚拟负载均衡）</p>
</li>
<li class="lvl-2">
<p>K8s Nginx Ingress Controller（不需要自己实现）</p>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/221757290.png" alt="image."><br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/222351496.png" alt="image."></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dasahboard-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dashboard-ingress</span></span><br><span class="line">  <span class="attr">namespacce:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">dashboard.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">        <span class="attr">serviceNamme:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">        <span class="attr">servicePort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f dashboard-ingress.yaml</span><br><span class="line"><span class="comment"># 查看 ingress ip</span></span><br><span class="line">kubectl get ingress -n kubernetes-dashboard --watch</span><br><span class="line">vim /etc/hosts <span class="comment"># add &#x27;ip dashboard.com&#x27; domain map</span></span><br><span class="line"><span class="comment"># 查看 ingress 默认 backend</span></span><br><span class="line">kubectl describe ingress dashboard-ingress -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>
<h4 id="Ingress-常用配置方法">Ingress 常用配置方法</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>单个 domain 配置多个映射路径<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/224919614.png" alt="image."></p>
</li>
<li class="lvl-2">
<p>多个 host 配置<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/225016142.png" alt="image."></p>
</li>
<li class="lvl-2">
<p>https 配置<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/225210493.png" alt="image."></p>
</li>
</ul>
<h3 id="HPA、KPA">HPA、KPA</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>HPA（Horizontal Pod Autoscaler）：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">HPA</a>是一种Kubernetes控制器，用于根据CPU利用率或自定义指标自动调整Pod的副本数。当Pod的CPU利用率或自定义指标超过或低于一定阈值时，HPA会自动增加或减少Pod的副本数，以确保应用程序的可用性和性能。要使用HPA，需要在Kubernetes集群中启用Metrics Server。</p>
</li>
<li class="lvl-2">
<p>KPA（Kubernetes Pod Autoscaler）：<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/run-application/autoscaling-pods/#autoscaling-based-on-memory-usage">KPA</a>是一种Kubernetes控制器，用于根据内存使用率自动调整Pod的容器资源限制。当Pod的内存使用率超过一定阈值时，KPA会自动增加Pod的容器资源限制，以确保应用程序的可用性和性能。与HPA不同，KPA不会增加或减少Pod的副本数，而是仅调整Pod的容器资源限制。</p>
</li>
</ul>
<h3 id="持久化-in-k8s">持久化 in k8s</h3>
<!-- todo -->
<h3 id="调度节点">调度节点</h3>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/">scheduling</a>。</p>
<p>要将另一台机器加入到当前Kubernetes集群中，需要执行以下步骤：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>在要加入集群的机器上安装Kubernetes组件，包括kubelet、kubeadm和kubectl等。</p>
</li>
<li class="lvl-2">
<p>在当前集群中的任意一台机器上运行以下命令，生成加入集群所需的token：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>
</li>
<li class="lvl-2">
<p>将第2步生成的加入集群的命令复制到要加入集群的机器上执行。例如：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join &lt;ip_address&gt;:&lt;port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</span><br></pre></td></tr></table></figure>
<p>其中，ip_address和port是当前Kubernetes集群中某一台机器的地址和端口号，token和hash是第2步生成的。</p>
</li>
<li class="lvl-2">
<p>等待几分钟，新的节点就会加入到集群中，并自动同步集群中的配置信息。</p>
</li>
<li class="lvl-2">
<p>可以使用kubectl命令查看新节点是否已经加入到集群中：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
<p>如果新节点已经加入到集群中，那么可以看到它的状态为Ready。</p>
</li>
</ul>
<h3 id="GPU">GPU</h3>
<!--
GPU Share https://github.com/AliyunContainerService/gpushare-scheduler-extender

    Example:
        https://www.jianshu.com/p/48a33e01230a

K8s:
    example:
        https://zhuanlan.zhihu.com/p/396775382
        https://developer.aliyun.com/article/742566
 -->
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 当部署单机k8s支持 GPU时，需要将control panel untaint，让master node 能调度</span></span><br><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/">https://kubernetes.io/docs/tasks/manage-gpus/scheduling-gpus/</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://developer.nvidia.com/zh-cn/blog/improving-gpu-utilization-in-kubernetes/">https://developer.nvidia.com/zh-cn/blog/improving-gpu-utilization-in-kubernetes/</a></p>
</li>
</ul>
<h3 id="reference">reference</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=s_o8dwzRlu4">https://www.youtube.com/watch?v=s_o8dwzRlu4</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=X48VuDVv0do">https://www.youtube.com/watch?v=X48VuDVv0do</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://docs.kubernetes.org.cn/227.html">http://docs.kubernetes.org.cn/227.html</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.kubernetes.org.cn/k8s">https://www.kubernetes.org.cn/k8s</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tutorials/">https://kubernetes.io/docs/tutorials/</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://developers.redhat.com/topics/kubernetes">books</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://opensource.com/resources/what-is-kubernetes">opensource k8s</a></p>
</li>
</ul>
<h2 id="minikube">minikube</h2>
<p><a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/">minikube</a> 是一个轻量级的 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/home/">Kubernetes</a> 实现，用于在本地机器上运行单节点 Kubernetes 集群。它支持多个驱动程序（Docker、containerd、cri-o、Podman 等），可以在 Linux、macOS 和 Windows 上运行。</p>
<h3 id="安装-2">安装</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>Linux 上</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64</span><br><span class="line"><span class="built_in">sudo</span> install minikube-linux-amd64 /usr/local/bin/minikube</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!TIP] 常见错误</p>
<p><strong>memory-swap is not allowed</strong></p>
<p>若在 docker 中使用minikube，则需要为 docker 容器开启 privileged 权限。</p>
</blockquote>
<ul class="lvl-0">
<li class="lvl-2">
<p>macOS 上</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install minikube</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>Windows 上</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choco install minikube</span><br></pre></td></tr></table></figure>
<h3 id="基本使用">基本使用</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化/启动 minikube 环境</span></span><br><span class="line">minikube start --driver=docker [--memory=2g] [--kubernetes-version=1.22.1]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止 minikube 环境</span></span><br><span class="line">minikube stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 minikube 环境</span></span><br><span class="line">minikube delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 minikube 中查看 api version</span></span><br><span class="line">minikube kubectl -- api-versions</span><br><span class="line">kubectl api-versions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 minikube 状态</span></span><br><span class="line">minikube status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 minikube IP</span></span><br><span class="line">minikube ip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 minikube 版本</span></span><br><span class="line">minikube version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 minikube dashboard</span></span><br><span class="line">minikube addons <span class="built_in">enable</span> metrics-server</span><br><span class="line">minikube dashboard</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动 Kubernetes 代理</span></span><br><span class="line">kubectl proxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 Kubernetes 代理</span></span><br><span class="line">http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>
<h3 id="运行应用">运行应用</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个 deployment</span></span><br><span class="line">kubectl create deployment hello-minikube --image=k8s.gcr.io/echoserver:1.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露 deployment 服务</span></span><br><span class="line">kubectl expose deployment hello-minikube --<span class="built_in">type</span>=NodePort --port=8080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line">kubectl get services</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问服务</span></span><br><span class="line">minikube service hello-minikube</span><br></pre></td></tr></table></figure>
<h3 id="本地多集群模拟">本地多集群模拟</h3>
<p>在minikube中，如果需要创建多个本地集群，可以使用以下步骤：</p>
<p>使用不同的文件夹或文件名安装多个minikube实例。例如，可以使用以下命令安装两个minikube实例：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>安装多个minikube实例，创建两个名为<code>cluster-1</code>和<code>cluster-2</code>的本地集群。</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">minikube start -p cluster-1</span><br><span class="line">minikube start -p cluster-2</span><br><span class="line"><span class="comment"># 列出找到的集群</span></span><br><span class="line">minikube profile list</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>设置当前使用的minikube实例</p>
</li>
</ul>
<p>在使用多个minikube实例时，需要使用<code>minikube profile</code>命令来设置当前使用的minikube实例。例如，要使用<code>cluster-1</code>实例，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube profile cluster-1</span><br></pre></td></tr></table></figure>
<p>然后，可以使用<code>kubectl</code>命令与该实例进行交互。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>删除minikube实例</p>
</li>
</ul>
<p>如果不再需要某个minikube实例，可以使用以下命令删除它：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">minikube delete -p cluster-1</span><br></pre></td></tr></table></figure>
<p>这将删除名为<code>cluster-1</code>的minikube实例。</p>
<h2 id="kind">kind</h2>
<p>使用 <a target="_blank" rel="noopener" href="https://kind.sigs.k8s.io/docs/user/quick-start#installation">kind</a> 创建本地 cluster。</p>
<p>安装完成后，可以使用 kind 来管理 Kubernetes 集群。一些常用的命令包括：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>kind create cluster: 创建一个新的 Kubernetes 集群</p>
</li>
<li class="lvl-2">
<p>kind delete cluster: 删除当前的 Kubernetes 集群</p>
</li>
<li class="lvl-2">
<p>kind get clusters: 获取当前存在的 Kubernetes 集群</p>
</li>
<li class="lvl-2">
<p>kind load docker-image: 将本地的 Docker 镜像加载到 kind 集群中</p>
</li>
<li class="lvl-2">
<p>kind export kubeconfig: 将 kind 集群的 kubeconfig 导出到本地文件中</p>
</li>
<li class="lvl-2">
<p>kind get nodes: 获取 kind 集群中的节点</p>
</li>
</ul>
<h3 id="gpu-support">gpu support</h3>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kind/issues/3164">https://github.com/kubernetes-sigs/kind/issues/3164</a></p>
</li>
</ul>
<h2 id="kubectl">kubectl</h2>
<p>kubectl 是 Kubernetes 的命令行工具，用于管理 Kubernetes 集群，C/S 架构。</p>
<h3 id="安装-3">安装</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>Linux 上</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl -LO <span class="string">&quot;https://dl.k8s.io/release/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span></span><br><span class="line"><span class="built_in">chmod</span> +x kubectl</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> kubectl /usr/local/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 kubectl 版本信息</span></span><br><span class="line">kubectl version --client</span><br><span class="line">kubectl version --client --output=yaml</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>macOS 上</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install kubectl</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>Windows 上</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choco install kubernetes<span class="literal">-cli</span></span><br></pre></td></tr></table></figure>
<h3 id="基本使用-2">基本使用</h3>
<p>k8s cli 工具 kubectl，提供了操作基本组件及交互能力。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>create/edit/delete deployment:基于 deployment 的 CRUD 操作</p>
</li>
<li class="lvl-2">
<p>get nodes/pod/service/replicaset/deployment: 查看 k8s 不同组件状态</p>
</li>
<li class="lvl-2">
<p>logs [pod name]: 调试 pod</p>
</li>
<li class="lvl-2">
<p>exec -it [pod name] – bash: 获取交互式终端</p>
</li>
<li class="lvl-2">
<p>describe pod [pod name]: 获取 pod 详情</p>
</li>
<li class="lvl-2">
<p>apply -f [file name]: 应用配置</p>
</li>
<li class="lvl-2">
<p>delete -f [file name]: 删除配置</p>
</li>
<li class="lvl-2">
<p>deployment 管理 replicaset</p>
</li>
<li class="lvl-2">
<p>replicaset 管理 pod</p>
</li>
<li class="lvl-2">
<p>pod 是容器的抽象</p>
</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 API Version</span></span><br><span class="line">kubectl api-version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Kubernetes 集群信息</span></span><br><span class="line">kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="comment"># subcommand</span></span><br><span class="line"><span class="comment">#   - pod</span></span><br><span class="line"><span class="comment">#   - service</span></span><br><span class="line"><span class="comment">#   - deployment</span></span><br><span class="line"><span class="comment">#   - replicaset</span></span><br><span class="line"><span class="comment">#   - configmap</span></span><br><span class="line"><span class="comment">#   - secret</span></span><br><span class="line"><span class="comment">#   - ingress</span></span><br><span class="line"><span class="comment">#   - pv</span></span><br><span class="line"><span class="comment">#   - pvc</span></span><br><span class="line"><span class="comment">#   - storageclass</span></span><br><span class="line"><span class="comment">#   - envet</span></span><br><span class="line"><span class="comment">#   - namespaces</span></span><br><span class="line"><span class="comment">#   - componentstatuses</span></span><br><span class="line"><span class="comment">#   - nodes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Kubernetes 节点信息</span></span><br><span class="line">kubectl get [subcommand]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Kubernetes 详细信息</span></span><br><span class="line">kubectl describe pod [name]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 Kubernetes 资源</span></span><br><span class="line">kubectl apply -f [file]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Kubernetes Pod</span></span><br><span class="line">kubectl delete pod [pod-name]</span><br><span class="line">kubectl delete pods -l &lt;label&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>
<h3 id="持久化存储">持久化存储</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个 PVC</span></span><br><span class="line">kubectl apply -f https://k8s.io/examples/pods/storage/pv-claim.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个 Pod</span></span><br><span class="line">kubectl apply -f https://k8s.io/examples/pods/storage/pv-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod</span></span><br><span class="line">kubectl get pod task-pv-pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 Pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it task-pv-pod -- /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Pod 中创建文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello World&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 Pod</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Pod</span></span><br><span class="line">kubectl delete pod task-pv-pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的 Pod</span></span><br><span class="line">kubectl apply -f https://k8s.io/examples/pods/storage/pv-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod</span></span><br><span class="line">kubectl get pod task-pv-pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 Pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it task-pv-pod -- /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件，输出 &quot;Hello World&quot;，说明 index.html 是被持久化在 PV 中的</span></span><br><span class="line"><span class="built_in">cat</span> /usr/share/nginx/html/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 Pod</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 PVC</span></span><br><span class="line">kubectl delete pvc task-pv-claim</span><br></pre></td></tr></table></figure>
<h3 id="pod-调试">pod 调试</h3>
<p>查看及调试 pod 详情，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/debug/debug-application/">k8s官方 POD 调试参考</a>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 deployment: kubectl create deployment [pod name] --images=xxxx</span></span><br><span class="line">kubectl create deployment nginx-depl --image=nginx</span><br><span class="line"><span class="comment"># 编辑 deployment nginx-depl: kubectl edit deployment [pod name]</span></span><br><span class="line"><span class="comment"># 查看 pod 信息发现自动创建一个新 deployment(running)，旧的 deployment(terminating)。</span></span><br><span class="line">kubectl edit deployment nginx-depl</span><br><span class="line"><span class="comment"># 删除 deployment :kubectl delete deployment [pod name]</span></span><br><span class="line">kubectl delete deployment nginx-depl</span><br><span class="line"><span class="comment"># 查看 部署更新状态</span></span><br><span class="line">kubectl rollout status [pod-name]</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 mongo depl</span></span><br><span class="line">kubectl create deployment mongo-depl --image=mongo</span><br><span class="line"><span class="comment"># 查看详情，状态为：mongo-depl(containerCreating)</span></span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl describe pod mongo-depl-xxxx</span><br><span class="line"><span class="comment"># 查看 debug pod name: kubectl logs [pod name]</span></span><br><span class="line">kubectl logs mongo-depl-xxxx</span><br><span class="line"><span class="comment"># 进入容器查看 kubectl exec -it [pod name] -- /bin/bash</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it mongo-depl-xxxx --  bash</span><br></pre></td></tr></table></figure>
<h2 id="k3d">k3d</h2>
<h3 id="gpu-workload">gpu workload</h3>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://k3d.io/v5.5.2/usage/advanced/cuda/#run-and-test-the-custom-image-with-k3d">https://k3d.io/v5.5.2/usage/advanced/cuda/#run-and-test-the-custom-image-with-k3d</a></p>
</li>
</ul>
<h2 id="kustomize">kustomize</h2>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kustomize">kustomize</a> 是一个用于Kubernetes部署的工具，它允许通过声明性配置来管理应用程序的部署。使用Kustomize，可以轻松地管理多个环境（如开发、测试和生产）之间的差异，而无需为每个环境创建单独的部署文件。</p>
<p>Kustomize使用Kubernetes的原生API来管理部署，因此它与Kubernetes的其他工具（如kubectl）非常兼容。此外，Kustomize还支持使用变量和模板来生成部署文件，使得管理大型应用程序变得更加容易。详情文档<a target="_blank" rel="noopener" href="https://kubectl.docs.kubernetes.io/guides/">参考</a>。</p>
<h3 id="安装-4">安装</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>Linux</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh&quot;</span>  | bash</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>Windows</p>
</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choco install kustomize</span><br></pre></td></tr></table></figure>
<h2 id="helm">helm</h2>
<h3 id="概念">概念</h3>
<p><a target="_blank" rel="noopener" href="https://helm.sh/zh/">helm</a> 是 k8s 包管理 yaml 工具。</p>
<p>helm charts</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>一堆 yaml 文件</p>
</li>
<li class="lvl-2">
<p>使用 helm 创建自己的 charts</p>
</li>
<li class="lvl-2">
<p>推送 chars 到 helm 仓库</p>
</li>
<li class="lvl-2">
<p>使用现有的 helm chars</p>
</li>
<li class="lvl-2">
<p>使用模板引擎配置 yaml</p>
</li>
</ul>
<p>helm char 结构<br>
<img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/230523187.png" alt="image."></p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/8ef3f56.html">helm 1 from escape</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/eb8ef4fd.html">helm 2 from escape</a></p>
</li>
</ul>
<h3 id="安装-5">安装</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二进制下载安装</span></span><br><span class="line">wget -o helm.tar.gz https://storage.googleapis.com/kubernetes-helm/helm-v2.13.1-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm.tar.gz</span><br><span class="line"><span class="comment"># 直接使用脚本安装</span></span><br><span class="line">curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</span><br><span class="line"><span class="comment"># 国内安装 https://mirrors.huaweicloud.com/helm/</span></span><br><span class="line">wget -o helm.tar.gz https://mirrors.huaweicloud.com/helm/v3.12.2/helm-v3.12.2-linux-amd64.tar.gz</span><br><span class="line">tar -zxvf helm.tar.gz</span><br><span class="line"><span class="built_in">cp</span> linux-amd64/helm /usr/local/bin/</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/intro/install/">https://helm.sh/zh/docs/intro/install/</a></p>
</li>
</ul>
<h3 id="基本使用-3">基本使用</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># helm repo add [NAME] [URL] [flags]</span></span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm repo add brigade https://brigadecore.github.io/charts</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm install [NAME] [CHART] [flags]</span></span><br><span class="line"><span class="comment"># 使用 my-values.yaml 值覆盖模板值安装</span></span><br><span class="line">helm install --values=my-values.yaml &lt;charname&gt;</span><br><span class="line"><span class="comment"># 直接指定值覆盖安装,多个值用逗号隔开</span></span><br><span class="line">helm install --<span class="built_in">set</span> version=v2.0.0</span><br><span class="line"></span><br><span class="line"><span class="comment">#  helm upgrade [RELEASE] [CHART] [flags]</span></span><br><span class="line">helm upgrade -i nvdp nvdp/nvidia-device-plugin \</span><br><span class="line">    --namespace nvdp \</span><br><span class="line">    --create-namespace \</span><br><span class="line">    --<span class="built_in">set</span>=runtimeClassName=nvidia \</span><br><span class="line">    --<span class="built_in">set</span>=image.repository=registry.gitlab.com/nvidia/kubernetes/device-plugin/staging/k8s-device-plugin \</span><br><span class="line">    --<span class="built_in">set</span>=image.tag=8b416016</span><br><span class="line"></span><br><span class="line"><span class="comment"># helm uninstall &lt;release_name&gt;</span></span><br><span class="line">helm uninstall nvdp</span><br></pre></td></tr></table></figure>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20221023/230750437.png" alt="image."></p>
<h3 id="打包">打包</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>helm create --generated-from-existing</code></p>
</li>
</ul>
<p>helm create --generate-from-existing` 是 Helm 命令行工具中的一个命令，用于从现有的 Kubernetes 资源中生成 Helm 包的模板。</p>
<p>它的语法是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create &lt;chart-name&gt; --generate-from-existing &lt;existing-resource&gt;</span><br></pre></td></tr></table></figure>
<p>其中，<code>&lt;chart-name&gt;</code> 是 Helm 包的名称，<code>&lt;existing-resource&gt;</code> 是现有的 Kubernetes 资源名称。</p>
<p>该命令将会从现有的 Kubernetes 资源中生成 Helm 包的模板，包括 <code>Chart.yaml</code>、<code>values.yaml</code> 和 <code>templates</code> 目录等文件。在生成的 Helm 包模板中，所有的 Kubernetes 资源将会被转换为 Helm 模板语法。</p>
<p>例如，假设我们有一个名为 <code>my-app</code> 的 Kubernetes 资源，我们可以使用以下命令生成一个 Helm 包模板：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm create my-chart --generate-from-existing my-app</span><br></pre></td></tr></table></figure>
<p>这将会在当前目录下生成一个名为 <code>my-chart</code> 的 Helm 包模板，其中包括 <code>Chart.yaml</code>、<code>values.yaml</code> 和 <code>templates</code> 目录等文件，所有的 Kubernetes 资源都会被转换为 Helm 模板语法。</p>
<p>需要注意的是，该命令只能生成基本的 Helm 包模板，仍然需要手动编辑以适应特定的需求。此外，该命令仅适用于 Kubernetes 资源，不适用于其他类型的资源。</p>
<h2 id="rancher">rancher</h2>
<p>rancher 是一个 全栈式 的 Kubernetes 容器管理平台，为提供在任何地方都能成功运行 Kubernetes 的工具。</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://ranchermanager.docs.rancher.com/zh/">rancher 中文文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://mirror.rancher.cn/">rancher 国内镜像</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://forums.rancher.cn/">rancher 国内论坛</a></p>
</li>
</ul>
<h3 id="安装-6">安装</h3>
<!--
https://zhuanlan.zhihu.com/p/403539342
https://zhuanlan.zhihu.com/p/495279401
https://blog.csdn.net/burn_in_hell/article/details/122908503
https://blog.csdn.net/burn_in_hell/article/details/122850969
https://blog.csdn.net/u012751272/article/details/120566298

https://blog.csdn.net/qq_43792385/article/details/104424848
https://blog.csdn.net/qq_43792385/article/details/104692634
-->
<p>单节点通过容器安装，并访问浏览器访问 ip:443，设置 admin 密码, 右下角可设置显示语言为简体中文。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --restart=unless-stopped \</span><br><span class="line">    --name rancher \</span><br><span class="line">    -p 80:80 -p 443:443 \</span><br><span class="line">    --privileged \</span><br><span class="line">    rancher/rancher:v2.5.9</span><br></pre></td></tr></table></figure>
<p>参考:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rancher2/best-practices/use-in-china/_index">rancher 国内加速</a></p>
</li>
</ul>
<h3 id="App">App</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/chenshanhao2008/article/details/113826476">https://blog.csdn.net/chenshanhao2008/article/details/113826476</a></p>
</li>
</ul>
<h3 id="gpu">gpu</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012751272/article/details/118859135">https://blog.csdn.net/u012751272/article/details/118859135</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012751272/article/details/120566298">https://blog.csdn.net/u012751272/article/details/120566298</a></p>
</li>
</ul>
<h2 id="rke">rke</h2>
<p>Rancher Kubernetes Engine，简称 RKE，是一个经过 CNCF 认证的 Kubernetes 安装程序。</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rke/_index">https://docs.rancher.cn/docs/rke/_index</a></p>
</li>
</ul>
<h2 id="k3s">k3s</h2>
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/zh/">K3s</a> 是一个轻量级的 Kubernetes 发行版，它针对边缘计算、物联网等场景进行了高度优化。</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/_index">https://docs.rancher.cn/docs/k3s/_index</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/k3s/1416">使用国内资源安装 K3s 全攻略</a></p>
</li>
</ul>
<h3 id="安装-7">安装</h3>
<h4 id="Quickstart">Quickstart</h4>
<p>使用脚本部署<a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/quick-start/_index/">快速部署</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://get.k3s.io | sh -</span><br><span class="line"><span class="comment"># 国内加速</span></span><br><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -</span><br><span class="line"><span class="comment"># 卸载时使用安装时的脚本卸载</span></span><br><span class="line">k3s-uninstall.sh</span><br></pre></td></tr></table></figure>
<p>运行此安装后,详情<a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/quick-start/_index/">参考</a>：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>K3s 服务将被配置为在节点重启后或进程崩溃或被杀死时自动重启.</p>
</li>
<li class="lvl-2">
<p>将安装其他实用程序，包括 kubectl, crictl, ctr, <a target="_blank" rel="noopener" href="http://k3s-killall.sh">k3s-killall.sh</a> 和 <a target="_blank" rel="noopener" href="http://k3s-uninstall.sh">k3s-uninstall.sh</a></p>
</li>
<li class="lvl-2">
<p>将kubeconfig文件写入到/<code>etc/rancher/k3s/k3s.yaml</code>，由 K3s 安装的 kubectl 将自动使用该文件.</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看安装的k3s服务</span></span><br><span class="line">systemctl status k3s</span><br><span class="line">journalctl -u k3s</span><br></pre></td></tr></table></figure>
<h4 id="Run-with-autok3s">Run with autok3s</h4>
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/autok3s/_index">AutoK3s</a> 是用于简化 K3s 集群管理的轻量级工具，可以使用 AutoK3s 在任何地方运行 K3s 服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd  --name autok3s \</span><br><span class="line">  --restart=unless-stopped \</span><br><span class="line">  -p 8080:8080 \</span><br><span class="line">  cnrancher/autok3s:v0.6.0</span><br></pre></td></tr></table></figure>
<h4 id="Run-k3s-in-docker">Run k3s in docker</h4>
<p>在容器中运行k3s集群, 镜像由 rancher 社区提供</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line">  --privileged \</span><br><span class="line">  --name k3s-server-1 \</span><br><span class="line">  --hostname k3s-server-1 \</span><br><span class="line">  -p 6443:6443 \</span><br><span class="line">  -d rancher/k3s:v1.24.10-k3s1 \</span><br><span class="line">  server</span><br></pre></td></tr></table></figure>
<p>运行起来后,通过kubeconfig进行访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> k3s-server-1:/etc/rancher/k3s/k3s.yaml ~/.kube/config</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!TIP]<br>
如果需要gpu支持的 k3s 运行在容器中时, 需要安装cuda及做相关<a target="_blank" rel="noopener" href="https://gist.github.com/markrexwinkel/3607c7073f6f94f2f05d51ef48c04e32">配置</a></p>
</blockquote>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/advanced#running-k3s-in-docker">https://docs.k3s.io/advanced#running-k3s-in-docker</a></p>
</li>
</ul>
<h4 id="Run-k3s-Based-on-docker">Run k3s Based on docker</h4>
<p>k3s默认使用自己维护的 <code>/var/lib/rancher/rke2/bin/containerd</code> 作为运行时. 以docker作为运行时需要指定参数: <code>-s - --docker</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://get.k3s.io | sh -s - --docker</span><br><span class="line"><span class="comment">#  国内</span></span><br><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_RKE2_MIRROR=cn sh -s - --docker</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!TIP]<br>
可以将k3s配置到使用docker的运行时,方便资源管理</p>
</blockquote>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/advanced#using-docker-as-the-container-runtime">https://docs.k3s.io/advanced#using-docker-as-the-container-runtime</a></p>
</li>
</ul>
<h4 id="Run-k3s-Based-on-containerd">Run k3s Based on containerd</h4>
<p>k3s默认使用自己维护的 <code>/var/lib/rancher/rke2/bin/containerd</code> 作为运行时, 如果需要用自定义的 containerd时,需指定参数 <code>-s - --container-runtime-endpoint /run/containerd/containerd.sock</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用默认的containerd</span></span><br><span class="line">curl -sfL https://get.k3s.io | sh -</span><br><span class="line"><span class="comment"># 使用自定义的containerd</span></span><br><span class="line">curl -sfL https://get.k3s.io | sh -s - --container-runtime-endpoint /run/containerd/containerd.sock</span><br><span class="line"><span class="comment">#  国内</span></span><br><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_RKE2_MIRROR=cn sh -s - --container-runtime-endpoint /run/containerd/containerd.sock</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!TIP]<br>
同时也可以将docker配置为使用自定义的containerd,方便资源管理</p>
</blockquote>
<p>编辑Docker的daemon.json文件（通常位于/etc/docker/daemon.json），添加以下内容, 然后重启docker服务<code>systemctl restart docker</code>：</p>
<figure class="highlight jsonc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="comment">// Set the execution options with native.cgroupdriver as systemd</span></span><br><span class="line">  <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the log driver as json-file</span></span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the log options with a maximum size of 100m</span></span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the storage driver as overlay2</span></span><br><span class="line">  <span class="attr">&quot;storage-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;overlay2&quot;</span><span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the containerd socket path</span></span><br><span class="line">  <span class="attr">&quot;containerd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/run/containerd/containerd.sock&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样，k3s和Docker就会使用同一个containerd实例作为其容器运行时, 在不考虑docker时优先使用containerd。</p>
<h4 id="QA-2">QA</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p><code>/var/lib/kubelet目录报Device or resource busy</code></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先卸载,再删除</span></span><br><span class="line">umount $(<span class="built_in">df</span> -HT | grep <span class="string">&#x27;/var/lib/kubelet&#x27;</span> | awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="访问集群">访问集群</h3>
<p>存储在 <code>/etc/rancher/k3s/k3s.yaml</code> 的是部署的k3集群的 kubeconfig 文件, 用于对 Kubernetes 集群的访问</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/rancher/k3s/k3s.yaml</span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line">helm <span class="built_in">ls</span> --all-namespaces</span><br></pre></td></tr></table></figure>
<p>直接指定 kubeconfig</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl --kubeconfig /etc/rancher/k3s/k3s.yaml get pods --all-namespaces</span><br><span class="line">helm --kubeconfig /etc/rancher/k3s/k3s.yaml <span class="built_in">ls</span> --all-namespaces</span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/cluster-access/_index">https://docs.rancher.cn/docs/k3s/cluster-access/_index</a></p>
</li>
</ul>
<h3 id="gpu-on-k3s">gpu on k3s</h3>
<p>Step 1, 准备节点(驱动等)<br>
Step 2, 安装 k8s nvidia plugins<br>
Step 3, benchmark测试</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/k8s-device-plugin">https://github.com/NVIDIA/k8s-device-plugin</a></p>
</li>
</ul>
<h4 id="Based-on-docker">Based on docker</h4>
<p>根据k3s<a target="_blank" rel="noopener" href="https://docs.k3s.io/advanced#nvidia-container-runtime-support">文档</a>,注册 RuntimeClass及nvidia设备发现及调度插件.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">docker</span> <span class="comment"># change to `docker` for dockerd</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># the following is same as k3s based on containerd</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://opni.io/setup/gpu/#rke">https://opni.io/setup/gpu/#rke</a></p>
</li>
</ul>
<h4 id="Based-on-containerd">Based on containerd</h4>
<p>根据k3s<a target="_blank" rel="noopener" href="https://docs.k3s.io/advanced#nvidia-container-runtime-support">文档</a>,注册 RuntimeClass及nvidia设备发现及调度插件.</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">node.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RuntimeClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia</span></span><br><span class="line"><span class="attr">handler:</span> <span class="string">nvidia</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># From https://github.com/NVIDIA/gpu-feature-discovery/blob/main/deployments/static/nfd.yaml</span></span><br><span class="line"><span class="comment"># Modified to set `runtimeClassName: nvidia`, as k3s does not replace the default container runtime</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfd</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfd-master</span></span><br><span class="line">      <span class="attr">runtimeClassName:</span> <span class="string">nvidia</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/kubernetes_incubator/node-feature-discovery:v0.6.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-master</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;nfd-master&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--extra-label-ns=nvidia.com&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/kubernetes_incubator/node-feature-discovery:v0.6.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">nfd-worker</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;nfd-worker&quot;</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--sleep-interval=60s&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&quot;--options=&#123;\&quot;sources\&quot;: &#123;\&quot;pci\&quot;: &#123; \&quot;deviceLabelFields\&quot;: [\&quot;vendor\&quot;] &#125;&#125;&#125;&quot;</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-boot</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/host-boot&quot;</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-os-release</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/host-etc/os-release&quot;</span></span><br><span class="line">              <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/host-sys&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">source-d</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/etc/kubernetes/node-feature-discovery/source.d/&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">features-d</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/etc/kubernetes/node-feature-discovery/features.d/&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-boot</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/boot&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-os-release</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/etc/os-release&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">host-sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/sys&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">source-d</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/etc/kubernetes/node-feature-discovery/source.d/&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">features-d</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/etc/kubernetes/node-feature-discovery/features.d/&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># From https://github.com/NVIDIA/gpu-feature-discovery/blob/main/deployments/static/gpu-feature-discovery-daemonset.yaml</span></span><br><span class="line"><span class="comment"># Modified to set `runtimeClassName: nvidia`, as k3s does not replace the default container runtime</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">node-feature-discovery</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.6</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">nvidia-gpu</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">      <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">nvidia-gpu</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/version:</span> <span class="number">0.6</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">app.kubernetes.io/part-of:</span> <span class="string">nvidia-gpu</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">runtimeClassName:</span> <span class="string">nvidia</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nvcr.io/nvidia/gpu-feature-discovery:v0.6.1</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">gpu-feature-discovery</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">output-dir</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/etc/kubernetes/node-feature-discovery/features.d&quot;</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dmi-product-name</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">&quot;/sys/class/dmi/id/product_name&quot;</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MIG_STRATEGY</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">none</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">feature.node.kubernetes.io/pci-10de.present:</span> <span class="string">&quot;true&quot;</span> <span class="comment"># NVIDIA vendor ID</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">output-dir</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/etc/kubernetes/node-feature-discovery/features.d&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dmi-product-name</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">&quot;/sys/class/dmi/id/product_name&quot;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># From https://github.com/NVIDIA/k8s-device-plugin/blob/master/nvidia-device-plugin.yml</span></span><br><span class="line"><span class="comment"># Modified to set `runtimeClassName: nvidia`, as k3s does not replace the default container runtime</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nvidia-device-plugin-daemonset</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nvidia-device-plugin-ds</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-ds</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="comment"># Mark this pod as a critical add-on; when enabled, the critical add-on</span></span><br><span class="line">      <span class="comment"># scheduler reserves resources for critical add-on pods so that they can</span></span><br><span class="line">      <span class="comment"># be rescheduled after a failure.</span></span><br><span class="line">      <span class="comment"># See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">&quot;system-node-critical&quot;</span></span><br><span class="line">      <span class="attr">runtimeClassName:</span> <span class="string">&quot;nvidia&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="comment"># The below image from gitlab works on the wsl2 from 2023/7/26, see</span></span><br><span class="line">      <span class="comment">#     - https://github.com/NVIDIA/k8s-device-plugin/issues/332#issuecomment-1650894074</span></span><br><span class="line">      <span class="comment">#     - https://gitlab.com/nvidia/kubernetes/device-plugin/container_registry</span></span><br><span class="line">      <span class="comment"># - image: registry.gitlab.com/nvidia/kubernetes/device-plugin/staging/k8s-device-plugin:8b416016</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nvcr.io/nvidia/k8s-device-plugin:v0.14.1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nvidia-device-plugin-ctr</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FAIL_ON_INIT_ERROR</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span> [<span class="string">&quot;ALL&quot;</span>]</span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/var/lib/kubelet/device-plugins</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">device-plugin</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/kubelet/device-plugins</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># https://catalog.ngc.nvidia.com/orgs/nvidia/teams/k8s/containers/cuda-sample</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cuda-sample-vectoradd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">runtimeClassName:</span> <span class="string">nvidia</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cuda-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_VISIBLE_DEVICES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">all</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NVIDIA_DRIVER_CAPABILITIES</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">all</span></span><br></pre></td></tr></table></figure>
<h4 id="Enable-with-helm">Enable with helm</h4>
<p>根据上面两种方式, 需设置 runtimeClassName, 在使用 helm 安装 k8s-device-plugin 步骤如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: node.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: RuntimeClass</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nvidia</span></span><br><span class="line"><span class="string">handler: nvidia # 创建基于 containerd 的RuntimeClass, 使用dockerd时改为docker</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">helm repo add nvdp https://nvidia.github.io/k8s-device-plugin</span><br><span class="line"><span class="comment"># 参考镜像:https://gitlab.com/nvidia/kubernetes/device-plugin/container_registry</span></span><br><span class="line">helm upgrade -i nvdp nvdp/nvidia-device-plugin \</span><br><span class="line">    --namespace nvdp \</span><br><span class="line">    --create-namespace \</span><br><span class="line">    --<span class="built_in">set</span>=runtimeClassName=nvidia \</span><br><span class="line">    --<span class="built_in">set</span>=image.repository=registry.gitlab.com/nvidia/kubernetes/device-plugin/staging/k8s-device-plugin \</span><br><span class="line">    --<span class="built_in">set</span>=image.tag=8b416016</span><br><span class="line"></span><br><span class="line">helm upgrade -i nvdp nvdp/nvidia-device-plugin \</span><br><span class="line">    --namespace nvdp \</span><br><span class="line">    --create-namespace \</span><br><span class="line">    --version v0.14.1 \</span><br><span class="line">    --<span class="built_in">set</span>=runtimeClassName=nvidia \</span><br><span class="line">    --<span class="built_in">set</span>=image.repository=nvcr.io/nvidia/k8s-device-plugin</span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s/issues/4391#issuecomment-1320992062">https://github.com/k3s-io/k3s/issues/4391#issuecomment-1320992062</a></p>
</li>
</ul>
<h4 id="Test">Test</h4>
<p>测试 cuda sample.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/NVIDIA/k8s-device-plugin/tree/master#running-gpu-jobs</span></span><br><span class="line"><span class="comment"># Add runtimeClassName to request gpu scheduled.</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | kubectl apply -f -</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: gpu-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  restartPolicy: Never</span></span><br><span class="line"><span class="string">  runtimeClassName: nvidia</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: cuda-container</span></span><br><span class="line"><span class="string">      image: nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span></span><br><span class="line"><span class="string">      resources:</span></span><br><span class="line"><span class="string">        limits:</span></span><br><span class="line"><span class="string">          nvidia.com/gpu: 1 # requesting 1 GPU</span></span><br><span class="line"><span class="string">  tolerations:</span></span><br><span class="line"><span class="string">  - key: nvidia.com/gpu</span></span><br><span class="line"><span class="string">    operator: Exists</span></span><br><span class="line"><span class="string">    effect: NoSchedule</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/advanced#nvidia-container-runtime-support">https://docs.k3s.io/advanced#nvidia-container-runtime-support</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/rancher/rke2/issues/3385#issuecomment-1640611574">https://github.com/rancher/rke2/issues/3385#issuecomment-1640611574</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/k3s-io/k3s/issues/4391#issuecomment-1233314825">https://github.com/k3s-io/k3s/issues/4391#issuecomment-1233314825</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/k8s-device-plugin#enabling-gpu-support-in-kubernetes">https://github.com/NVIDIA/k8s-device-plugin#enabling-gpu-support-in-kubernetes</a></p>
</li>
</ul>
<h3 id="k3s-registry-mirror">k3s registry mirror</h3>
<p>如果从国内环境安装 K3s 可能会遇到安装速度特别缓慢或者 time out 的情况，从以上的安装过程可以分析出主要由以下几个原因导致：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>K3s 的安装脚本<a target="_blank" rel="noopener" href="https://get.k3s.io">https://get.k3s.io</a>存储在国外的服务器，从国内环境访问可能出现无法访问的情况</p>
</li>
<li class="lvl-2">
<p>K3s 默认安装 stable 版本，stable 对应的具体 K3s 版本是通过 <a target="_blank" rel="noopener" href="https://update.k3s.io/v1-release/channels">https://update.k3s.io/v1-release/channels</a> 解析来的，而这个地址也是运行在一个国外的服务器上</p>
</li>
<li class="lvl-2">
<p>当通过 channel 解析出对应 K3s 的版本为：v1.25.3+k3s1，此时需要到 github 上拉取对应的 K3s 二进制文件。虽然这个二进制文件才几十兆，但国内环境访问 github 经常会出现无法访问的情况。</p>
</li>
</ul>
<p>配置国内镜像</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/rancher/k3s/registries.yaml</span></span><br><span class="line"><span class="string">mirrors:</span></span><br><span class="line"><span class="string">  &quot;docker.io&quot;:</span></span><br><span class="line"><span class="string">    endpoint:</span></span><br><span class="line"><span class="string">      - &quot;https://docker.mirrors.ustc.edu.cn&quot; # 可根据需求替换 mirror 站点</span></span><br><span class="line"><span class="string">      - &quot;https://registry-1.docker.io&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">systemctl restart k3s</span><br><span class="line"><span class="comment"># 核查registry字段验证是否生效</span></span><br><span class="line">crictl info</span><br></pre></td></tr></table></figure>
<p>经过以上配置后，通过 K3s 拉取的镜像如果在配置的 mirror 站点中存在，那么将会从该站点拉取镜像。如果不存在，将会从默认的 <a target="_blank" rel="noopener" href="http://docker.io">docker.io</a> 中拉取镜像。</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/k3s/1416#k3s-mirror-4">配置k3s registry.yml</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.k3s.io/installation/private-registry">https://docs.k3s.io/installation/private-registry</a></p>
</li>
</ul>
<h3 id="traefik">traefik</h3>
<p>默认情况下，K3s 1.21 及更高版本默认安装 Traefik v2。出于安全考虑，默认不公开 Traefik Dashboard。<a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/k3s-traefik-dashborad/699#traefik-v2-dashborad-3">参考</a></p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/k3s-traefik-dashborad/699">如何在 K3s 中启用 traefik dashborad</a></p>
</li>
</ul>
<h3 id="crictl">crictl</h3>
<p><code>crictl</code> 是一个用于与 Kubernetes 中的容器运行时接口 (CRI) 进行交互的命令行工具。它允许在 Kubernetes 集群中管理容器和 Pod。它提供了创建、列出、启动、停止和删除容器等功能。</p>
<h4 id="基本使用-4">基本使用</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示容器运行时信息</span></span><br><span class="line">crictl info</span><br><span class="line"><span class="comment"># 查看镜像</span></span><br><span class="line">crictl images</span><br><span class="line"><span class="comment"># 查看pods</span></span><br><span class="line">crictl pods</span><br></pre></td></tr></table></figure>
<h4 id="–runtime-endpoint">–runtime-endpoint</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过环境变量指定运行时终端</span></span><br><span class="line"><span class="built_in">export</span> CONTAINER_RUNTIME_ENDPOINT=unix:///run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过配置文件指定</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;runtime-endpoint: unix:///run/containerd/containerd.sock&#x27;</span> &gt;&gt; /etc/crictl.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令参数指定</span></span><br><span class="line">crictl --runtime-endpoint unix:///run/containerd/containerd.sock info</span><br></pre></td></tr></table></figure>
<h2 id="rke2">rke2</h2>
<p><a target="_blank" rel="noopener" href="https://docs.rke2.io/zh/">rke2</a>，也被称为 RKE Government，是 Rancher 的下一代 Kubernetes 发行版</p>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rke2/_index/">https://docs.rancher.cn/docs/rke2/_index/</a></p>
</li>
</ul>
<h3 id="安装-8">安装</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/rke2/install/quickstart/_index">快速部署</a></p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -sfL https://get.rke2.io | sh -</span><br><span class="line"><span class="comment"># 国内加速</span></span><br><span class="line">curl -sfL https://rancher-mirror.rancher.cn/rke2/install.sh | INSTALL_RKE2_MIRROR=cn sh -</span><br></pre></td></tr></table></figure>
<p>links:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://forums.rancher.cn/t/rke2-rancher-ha/689">RKE2 安装 Rancher HA 的国内加速器</a></p>
</li>
</ul>
<h2 id="istio">istio</h2>
<p>解析微服务实践中网络稳定的痛点，实践中通常使用服务网格 <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=VAKotZT8SMI&amp;list=PLo0iJFLQIBEaqom6wvP9qsSJQalc2TkaQ">Service Mesh</a>。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=16fgzklcF7Y">15min 入门</a></p>
</li>
</ul>
<h3 id="Service-Mesh-演化">Service Mesh 演化</h3>
<ul class="lvl-0">
<li class="lvl-2">
<p>代码逻辑处理网络可靠，难维护</p>
</li>
<li class="lvl-2">
<p>公共库，解决耦合</p>
</li>
<li class="lvl-2">
<p>代理，功能简陋</p>
</li>
<li class="lvl-2">
<p>Sidecar</p>
</li>
<li class="lvl-2">
<p>Service Mesh</p>
</li>
<li class="lvl-2">
<p>Service Mesh V2（加了控制平面）</p>
</li>
</ul>
<h3 id="Service-Mesh">Service Mesh</h3>
<blockquote>
<p>[!NOTE]<br>
A service mesh is a dedicated <strong>infrastructure layer</strong> for handling service-to-service communication.  It’s responsible for the reliable <strong>delivery of requests</strong> through the complex topology of services that comprise a modern,cloud native application.  In practice,the service mesh is typically implemented as an array of lightweight <strong>network proxies</strong> that are deployed alongside application code,<strong>without the application needing to be aware</strong>.</p>
</blockquote>
<p>服务网格是用于处理服务到服务通信的专用基础设施层。它负责通过组成现代云原生应用程序的复杂服务拓扑可靠地交付请求。在实践中，服务网格通常被实现为一组轻量级网络代理，它们与应用程序代码一起部署，而不需要应用程序察觉。即，应用中服务会有额外的Sidecar服务代理请求并可靠的提供通信的网络拓扑。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>流量控制</p>
<ul class="lvl-2">
<li class="lvl-4">路由</li>
<li class="lvl-4">超时重试</li>
<li class="lvl-4">故障处理</li>
</ul>
</li>
<li class="lvl-2">
<p>策略</p>
<ul class="lvl-2">
<li class="lvl-4">流量限制</li>
<li class="lvl-4">黑白名单</li>
</ul>
</li>
<li class="lvl-2">
<p>网络安全</p>
<ul class="lvl-2">
<li class="lvl-4">授权</li>
<li class="lvl-4">身份验证</li>
</ul>
</li>
<li class="lvl-2">
<p>可观察性</p>
<ul class="lvl-2">
<li class="lvl-4">指标搜集展示</li>
<li class="lvl-4">日志收集</li>
<li class="lvl-4">分布式跟踪</li>
</ul>
</li>
</ul>
<p>Service Mesh 标准：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>UDPA，同一的数据平面API，为不同数据平面提供API接入。</p>
</li>
<li class="lvl-2">
<p>SMI，为用户提供统一的控制平面。</p>
</li>
</ul>
<h3 id="istio-2">istio</h3>
<h4 id="istio-定义">istio 定义</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>服务网格产品</p>
</li>
<li class="lvl-2">
<p>对应用层透平</p>
</li>
<li class="lvl-2">
<p>为微服务架构设计</p>
</li>
<li class="lvl-2">
<p>可连接、保护、控制遥测系统</p>
</li>
</ul>
<h4 id="istio-核心资源-CRD">istio 核心资源 CRD</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>虚拟服务（Virtual Service）</p>
<ul class="lvl-2">
<li class="lvl-4">将流量路由给定目标规则</li>
<li class="lvl-4">请求地址和真实工作负载解耦</li>
<li class="lvl-4">包含一组路由规则</li>
<li class="lvl-4">丰富的路由匹配规则</li>
</ul>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20230421/065015394.png" alt="虚拟服务"></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>目标规则（Destination Rule）</p>
<ul class="lvl-2">
<li class="lvl-4">定义虚拟服务路由到目标真实地址，即子集</li>
<li class="lvl-4">负载均衡，随机、权重、最小请求数</li>
</ul>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20230421/065604918.png" alt="目标规则"></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>网关（Gateway）</p>
<ul class="lvl-2">
<li class="lvl-4">管理进出网格的流量</li>
<li class="lvl-4">处在网格边界</li>
</ul>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20230421/065816653.png" alt="网关"></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>服务入口（Service Entry）</p>
<ul class="lvl-2">
<li class="lvl-4">把外部服务注册到网格中
<ul class="lvl-4">
<li class="lvl-6">为外部目标转发请求</li>
<li class="lvl-6">添加超时重试等策略</li>
<li class="lvl-6">扩展网络</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20230421/070100196.png" alt="服务入口"></p>
<ul class="lvl-0">
<li class="lvl-2">
<p>Sidecar</p>
<ul class="lvl-2">
<li class="lvl-4">调整 Envoy 代理接管的端口和协议</li>
<li class="lvl-4">限制 Envoy 代理可访问的服务</li>
</ul>
</li>
</ul>
<p><img data-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://raw.githubusercontent.com/msclock/images/main/images/20230421/070244993.png" alt="Sidecar"></p>
<h4 id="可观测性">可观测性</h4>
<ul class="lvl-0">
<li class="lvl-2">
<p>可观察性 != 监控</p>
</li>
<li class="lvl-2">
<p>组成：指标、日志、追踪</p>
</li>
</ul>
<p>指标（Metrics）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>以聚合方式监控和理解系统行为</p>
</li>
<li class="lvl-2">
<p>istio 中指标的分类</p>
<ul class="lvl-2">
<li class="lvl-4">代理级别指标（Proxy-level）</li>
<li class="lvl-4">服务级别指标（Service-level）</li>
<li class="lvl-4">控制平面指标（Control plane）</li>
</ul>
</li>
</ul>
<p>日志（Logging）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>系统产生事件了解系统</p>
</li>
<li class="lvl-2">
<p>包含完整的元数据信息（目标、源）</p>
</li>
<li class="lvl-2">
<p>生成位置可选（本地、远端，如filebeat）</p>
</li>
<li class="lvl-2">
<p>日志内容</p>
<ul class="lvl-2">
<li class="lvl-4">应用日志</li>
<li class="lvl-4">Envoy 日志 <code>kubectl logs -l app=demo -c istio-proxy</code></li>
</ul>
</li>
</ul>
<p>追踪（Tracing）</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>通过追踪请求，了解服务调用关系</p>
</li>
<li class="lvl-2">
<p>常用于调用链的问题排查、性能分析等</p>
</li>
<li class="lvl-2">
<p>支持多种追踪系统（Jeager、Zipkin、Datadog）</p>
</li>
</ul>
<h4 id="安全架构">安全架构</h4>
<p>认证</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>对等认证（Peer authentication）</p>
<ul class="lvl-2">
<li class="lvl-4">服务间身份认证</li>
<li class="lvl-4">Mutual TLS(mTLS)</li>
</ul>
</li>
<li class="lvl-2">
<p>请求认证（Request authentication）</p>
<ul class="lvl-2">
<li class="lvl-4">终端用户身份认证</li>
<li class="lvl-4">JSON Web Token(JWT)</li>
</ul>
</li>
</ul>
<p>授权</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>授权级别</p>
</li>
<li class="lvl-2">
<p>策略分发</p>
</li>
<li class="lvl-2">
<p>授权引擎</p>
</li>
<li class="lvl-2">
<p>无需显示启用</p>
</li>
</ul>
<h4 id="安装-9">安装</h4>
<p>配置安装 <a target="_blank" rel="noopener" href="https://istio.io/latest/docs/setup/getting-started/#download">istio</a>。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=voAyroDb6xk">istio setup in k8s</a></p>
</li>
</ul>
<blockquote>
<p>[!NOTE]<br>
istio 需要匹配k8s环境。</p>
<p><code>curl -L https://istio.io/downloadIstio | sh -</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">istioctl version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要测试环境demo的话可将 profile 从 default 到 demo</span></span><br><span class="line"><span class="comment"># default for production</span></span><br><span class="line">istioctl manifest apply</span><br><span class="line"><span class="comment"># demo mode for learning</span></span><br><span class="line">istioctl manifest apply --<span class="built_in">set</span> profile=demo</span><br><span class="line"><span class="comment"># custom 增加 default + grafana</span></span><br><span class="line">istioctl manifest apply --<span class="built_in">set</span> addonComponents.grafana.enable=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 istio pod</span></span><br><span class="line">kubectl get ns</span><br><span class="line">kubectl get pod -n istio-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 istio crd/api</span></span><br><span class="line">kubectl get crd | grep istio</span><br><span class="line">kubectl api-resources | grep istio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">istioctl dashboard kiali</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加一个名称空间标签，以指示 istio 在以后部署应用程序时自动注入特使边车代理</span></span><br><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!TIP]<br>
可以部署 Bookinfo 应用，验证istio。</p>
<p>示例部署 Bookinfo，并使用默认的 gateway 配置 ingressgateway，然后导出 8099 给外部访问。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml</span><br><span class="line">kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml</span><br><span class="line">kubectl port-forward svc/istio-ingressgateway 8099:80 -n istio-system</span><br><span class="line">curl localhost:8099/productpage</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="Virtucal-Service-和-Destination-Rule">Virtucal Service 和 Destination Rule</h4>
<p>可实现的功能：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>按服务版本路由</p>
<ul class="lvl-2">
<li class="lvl-4">将流量都路由到v1，samples/bookinfo/networking/virtual-service-all-v1.yaml</li>
</ul>
</li>
<li class="lvl-2">
<p>按比例流量区分</p>
</li>
<li class="lvl-2">
<p>根据匹配规则进行路由</p>
<ul class="lvl-2">
<li class="lvl-4">根据请求url前缀匹配，samples/bookinfo/networking/bookinfo-gateway.yaml</li>
</ul>
</li>
<li class="lvl-2">
<p>定义各种策略（负载均衡、连接池等）</p>
</li>
</ul>
<h2 id="knative">knative</h2>
<blockquote>
<p>[!NOTE]<br>
knative is an Open-Source Enterprise-level solution to build Serverless and Event Driven Applications.</p>
</blockquote>
<p>Knative是一个企业级的开源软件构建无服务器和事件驱动应用程序的解决方案。</p>
<h3 id="knative-文档">knative 文档</h3>
<p>要了解如何在Kubernetes上使用Knative，需要重点关注以下文档：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://knative.dev/docs/">Knative官方文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/home/">Kubernetes官方文档</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="http://docs.kubernetes.org.cn/">Kubernetes中文文档</a></p>
</li>
</ul>
<p>Knative官方文档中的以下章节对于了解Knative也非常重要：</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://knative.dev/docs/serving/">knative Serving</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://knative.dev/docs/eventing/">knative Eventing</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://knative.dev/docs/build/">knative Build</a></p>
</li>
</ul>
<h2 id="traefik-2">traefik</h2>
<p>Traefik是一种流行的反向代理和负载均衡器，可用于将流量路由到不同的后端服务。它支持多种后端服务，例如Docker，Kubernetes和Consul等。Traefik还提供了许多有用的功能，例如自动发现和自动配置。</p>
<p>参考:</p>
<ul class="lvl-0">
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://www.smarthomebeginner.com/traefik-docker-compose-guide-2022/">https://www.smarthomebeginner.com/traefik-docker-compose-guide-2022/</a></p>
</li>
<li class="lvl-2">
<p><a target="_blank" rel="noopener" href="https://github.com/htpcBeginner/docker-traefik">https://github.com/htpcBeginner/docker-traefik</a></p>
</li>
</ul>
<h3 id="traefik-示例">traefik 示例</h3>
<h4 id="docker-compose-示例">docker-compose 示例</h4>
<p>如果正在使用Docker，则可以使用Traefik作为反向代理和负载均衡器。Traefik可以自动发现Docker容器，并将流量路由到正确的容器。以下是一个示例docker-compose文件，其中包含Traefik和一个Web服务：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">traefik:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">traefik:v2.4</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--api.insecure=true&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--providers.docker=true&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--providers.docker.exposedbydefault=false&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;--entrypoints.web.address=:80&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/var/run/docker.sock:/var/run/docker.sock&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;traefik.enable=true&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;traefik.http.routers.web.rule=Host(`web.example.com`)&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;traefik.http.services.web.loadbalancer.server.port=80&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the lines to hosts and open example.com in browser</span></span><br><span class="line"><span class="comment"># 127.0.0.1 web.example.com</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，Traefik将监听端口80，并将流量路由到Web服务。Web服务使用Traefik标签来指示Traefik应该将其作为后端服务使用。Traefik还使用标签来指定路由规则。</p>
<h4 id="k8s-示例">k8s 示例</h4>
<p>在Kubernetes中，Traefik可以使用Kubernetes Ingress对象来路由流量。</p>
<p>要在Kubernetes中使用Traefik，请按照以下步骤操作：</p>
<p>安装Traefik Operator，Traefik Operator是一个Kubernetes控制器，用于管理Traefik实例。可以使用Helm Chart安装Traefik Operator。以下是安装Traefik Operator的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add traefik https://helm.traefik.io/traefik</span><br><span class="line">helm repo update</span><br><span class="line">helm install traefik-operator traefik/traefik-operator</span><br></pre></td></tr></table></figure>
<p>创建Traefik实例，要在Kubernetes中使用Traefik，需要创建一个Traefik实例。可以使用Traefik CRD（Custom Resource Definition）来定义Traefik实例。以下是一个示例Traefik CRD：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TraefikService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">traefik</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">api:</span></span><br><span class="line">    <span class="attr">dashboard:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">address:</span> <span class="string">&quot;:80&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">address:</span> <span class="string">&quot;:443&quot;</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，Traefik将监听端口80和8080，并将流量路由到正确的后端服务。Traefik还将启用Traefik Dashboard，并监听端口8080。</p>
<p>要创建Traefik实例，请使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f traefik-crd.yaml</span><br></pre></td></tr></table></figure>
<p>创建网关，网关可以使用 k8s 网关或 traefik IngressRoute。</p>
<ul class="lvl-0">
<li class="lvl-2">
<p>创建Ingress对象</p>
</li>
</ul>
<p>要在Kubernetes中使用Traefik路由流量，需要创建一个Ingress对象。以下是一个示例Ingress对象：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/router.entrypoints:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">traefik.ingress.kubernetes.io/router.rule:</span> <span class="string">&quot;Host(`example.com`)&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，Ingress对象将流量路由到名为“web”的Kubernetes Service。Traefik将使用标签“<a target="_blank" rel="noopener" href="http://traefik.ingress.kubernetes.io/router.rule%E2%80%9D%E6%9D%A5%E6%8C%87%E5%AE%9A%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E3%80%82">traefik.ingress.kubernetes.io/router.rule”来指定路由规则。</a></p>
<p>要创建Ingress对象，请使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress.yaml</span><br></pre></td></tr></table></figure>
<ul class="lvl-0">
<li class="lvl-2">
<p>创建Traefik IngressRoute</p>
</li>
</ul>
<p>在Kubernetes上使用Traefik的信息，并且想要了解如何使用Traefik IngressRoute。Traefik IngressRoute是Traefik的一种扩展，它提供了更多的路由选项和更好的可读性。要在Kubernetes中使用Traefik IngressRoute路由流量，需要创建一个IngressRoute对象。以下是一个示例IngressRoute对象：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">traefik.containo.us/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IngressRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">entryPoints:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span> <span class="string">Host(`example.com`)</span> <span class="string">&amp;&amp;</span> <span class="string">PathPrefix(`/web`)</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">Rule</span></span><br><span class="line">      <span class="attr">services:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">port:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>在此示例中，IngressRoute对象将流量路由到名为“web”的Kubernetes Service。Traefik将使用标签“match”来指定路由规则。</p>
<p>要创建IngressRoute对象，请使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingressroute.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>[!NOTE]<br>
Traefik和Istio是两个不同的工具，它们都可以用于在Kubernetes中管理流量路由和负载均衡，但它们的设计目标和功能略有不同。</p>
<p>Traefik是一个轻量级的反向代理和负载均衡器，它专注于将流量路由到正确的后端服务。Traefik提供了许多路由选项和可插拔的中间件，例如TLS证书管理和HTTP重定向。Traefik还提供了一个易于使用的Web UI，用于监视和管理流量路由。</p>
<p>相比之下，Istio是一个更全面的服务网格解决方案，它提供了更多的功能，例如流量管理、安全性和可观察性。Istio使用Envoy作为其数据平面，Envoy是一个高性能的代理，它可以在应用程序和服务之间进行流量路由和负载均衡。Istio还提供了一些高级功能，例如流量控制、故障注入和跟踪。</p>
<p>因此，如果只需要一个简单的反向代理和负载均衡器，Traefik可能是更好的选择。但是，如果需要更全面的服务网格功能，例如流量管理和安全性，那么Istio可能更适合需求。</p>
</blockquote>
<h2 id="opentelemetry">opentelemetry</h2>
<p><a target="_blank" rel="noopener" href="https://opentelemetry.io/">opentelemetry</a> 是一个api、sdk和工具的集合。使用它来检测、生成、收集和导出遥测数据(度量、日志和跟踪)，以帮助分析软件的性能和行为。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Msclock
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://msclock.github.io/posts/655061ae/" title="k8s">https://msclock.github.io/posts/655061ae/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="followme">
  <span>欢迎关注我的其它发布渠道</span>

  <div class="social-list">

      <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
      </div>
  </div>
</div>


        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/4c738f59/" rel="prev" title="开发资源导航">
                  <i class="fa fa-angle-left"></i> 开发资源导航
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/8f889db4/" rel="next" title="应用架构">
                  应用架构 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="lv-container" data-id="city" data-uid="MTAyMC81Njg4MS8zMzM0NQ=="></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2019 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Msclock</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">426k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:27</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/msclock" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>

<script>
var options = {
  bottom: '64px',
  right: 'unset',
  left: '32px',
  time: '0.5s',
  mixColor: 'transparent',
  backgroundColor: 'transparent',
  buttonColorDark: '#100f2c',
  buttonColorLight: '#fff',
  saveInCookies: true,
  label: '🌓',
  autoMatchOsTheme: true
}
const darkmode = new Darkmode(options);
window.darkmode = darkmode;
darkmode.showWidget();
</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-theme-next@8.23.1/source/js/third-party/comments/livere.min.js" defer></script>


        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z\d\-\.\+]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(t.test(e.href)||r.test(e.href))&&(e.href=a.dataset.original)})});</script><script>(r=>{r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,o=r.imageLazyLoadSetting.preloadRatio||1,d=i();function i(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=i());for(var e,n=0;n<d.length;n++)0<=(e=(e=d[n]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*o||document.documentElement.clientHeight*o)&&(()=>{var t,e,a,o,i=d[n];e=function(){d=d.filter(function(t){return i!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(i)},(t=i).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,o=t.getAttribute("data-original"),a.onload=function(){t.src=o,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=o},t.src!==o&&(a.src=o)))})()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)})(this);</script></body>
</html>
